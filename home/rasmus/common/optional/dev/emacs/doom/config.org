#+title: Doom Emacs
#+PROPERTY: header-args :tangle config.el
#+auto_tangle: t
#+STARTUP: overview
#+AUTHOR: Rasmus Enevoldsen

* Table :toc:
- [[#doom-emacs-config][DOOM Emacs config]]
- [[#name--email][Name & Email]]
- [[#fonts][Fonts]]
  - [[#ligature][Ligature]]
- [[#theme][Theme]]
- [[#completion][Completion]]
  - [[#vertico][Vertico]]
  - [[#consult][Consult]]
  - [[#marginalia][Marginalia]]
  - [[#embark][Embark]]
- [[#org-mode][Org-mode]]
  - [[#directories][Directories]]
  - [[#ui][UI]]
  - [[#org-roam][org-roam]]
  - [[#hyper-links][Hyper Links]]
  - [[#latex][LaTeX]]
  - [[#anki][Anki]]
  - [[#org-auto-tangle][Org-auto-tangle]]
  - [[#org-download][Org-download]]
  - [[#org-transclusion][org-transclusion]]
  - [[#images][Images]]
- [[#programming-setup][Programming Setup]]
  - [[#languages][Languages]]
  - [[#tools][Tools]]
  - [[#projectile][Projectile]]

* DOOM Emacs config
To Tangle a document press =

#+begin_src elisp :tangle yes
;;; $DOOMDIR/config.el -*- lexical-binding: t; -*-

;; Place your private configuration here! Remember, you do not need to run 'doom
;; sync' after modifying this file!
#+end_src

* Name & Email                    
#+begin_src elisp :tangle yes
;; Some functionality uses this to identify you, e.g. GPG configuration, email
;; clients, file templates and snippets. It is optional.
(setq user-full-name "Rasmus Enevoldsen"
      user-mail-address "rasmus@enev.dk")
#+end_src

* Fonts
#+begin_src elisp :tangle yes
;; Doom exposes five (optional) variables for controlling fonts in Doom:
;;
;; - `doom-font' -- the primary font to use
;; - `doom-variable-pitch-font' -- a non-monospace font (where applicable)
;; - `doom-big-font' -- used for `doom-big-font-mode'; use this for
;;   presentations or streaming.
;; - `doom-symbol-font' -- for symbols
;; - `doom-serif-font' -- for the `fixed-pitch-serif' face
;;
;; See 'C-h v doom-font' for documentation and more examples of what they
;; accept. For example:
;;
(setq doom-font (font-spec :family "JetBrains Mono" :size 20)
     doom-variable-pitch-font (font-spec :family "FiraGO" :size 21)
     doom-symbol-font (font-spec :family "Nerd Font" :size 21)
     doom-serif-font (font-spec :family "JetBrains Mono" :size 20))

#+end_src

** Ligature

#+begin_src elisp :tangle yes
;; https://docs.doomemacs.org/v21.12/#/configuration/setting-ligatures
#+end_src

#+RESULTS:

* Theme
#+begin_src elisp :tangle yes
;; If you or Emacs can't find your font, use 'M-x describe-font' to look them
;; up, `M-x eval-region' to execute elisp code, and 'M-x doom/reload-font' to
;; refresh your font settings. If Emacs still can't find your font, it likely
;; wasn't installed correctly. Font issues are rarely Doom issues!

;; There are two ways to load a theme. Both assume the theme is installed and
;; available. You can either set `doom-theme' or manually load a theme with the
;; `load-theme' function. This is the default:
;; https://github.com/doomemacs/themes/tree/screenshots
(setq doom-theme 'doom-one)

(set-frame-parameter nil 'alpha-background 80) ; For current frame
(add-to-list 'default-frame-alist '(alpha-background . 80)) ; For all new frames henceforth

;; This determines the style of line numbers in effect. If set to `nil', line
;; numbers are disabled. For relative line numbers, set this to `relative'.
(setq display-line-numbers-type 'relative)

(add-to-list 'default-frame-alist '(undecorated . t))

;; If you use `org' and don't want your org files in the default location below,
;; change `org-directory'. It must be set before org loads!
;; (setq org-directory "~/.local/share/org/")


;; Whenever you reconfigure a package, make sure to wrap your config in an
;; `after!' block, otherwise Doom's defaults may override your settings. E.g.
;;
;;   (after! PACKAGE
;;     (setq x y))
;;
;; The exceptions to this rule:
;;
;;   - Setting file/directory variables (like `org-directory')
;;   - Setting variables which explicitly tell you to set them before their
;;     package is loaded (see 'C-h v VARIABLE' to look up their documentation).
;;   - Setting doom variables (which start with 'doom-' or '+').
;;
;; Here are some additional functions/macros that will help you configure Doom.
;;
;; - `load!' for loading external *.el files relative to this one
;; - `use-package!' for configuring packages
;; - `after!' for running code after a package has loaded
;; - `add-load-path!' for adding directories to the `load-path', relative to
;;   this file. Emacs searches the `load-path' when you load packages with
;;   `require' or `use-package'.
;; - `map!' for binding new keys
;;
;; To get information about any of these functions/macros, move the cursor over
;; the highlighted symbol at press 'K' (non-evil users must press 'C-c c k').
;; This will open documentation for it, including demos of how they are used.
;; Alternatively, use `C-h o' to look up a symbol (functions, variables, faces,
;; etc).
;;
;; You can also try 'gd' (or 'C-c c d') to jump to their definition and see how
;; they are implemented.


#+end_src

* Completion
https://midirus.com/blog/from-ivy-to-vertico#the-vertco-stack

Here we setup all the grepping and completion in Emacs using the powerful Consult/Vertico/Embark/Corfu ecosystem.
Note that these packages supersede the older (but more established) Ivy/Counsel/etc ecosystem.
** Vertico

[[https://github.com/minad/vertico][vertico.el]] is a package that offers a vertical completion interface, simplifying navigation and selection within the minibuffer.

Letâ€™s activate vertico-mode like so:
#+begin_src emacs-lisp :tangle yes :results none
  (use-package! vertico
    :init
    (vertico-mode)
    (vertico-multiform-mode)
    :config
    (setq vertico-multiform-categories
  	'((file reverse) ;; this is for finding files
  	  (command reverse) ;; this is for M-x
  	  (minor-mode reverse)
  	  (imenu buffer)
  	  (t reverse)))
    (setq vertico-multiform-commands
          '(
  	  ;; projectile
  	  (projectile-find-file reverse)
            (projectile-find-dir reverse)
            (projectile-switch-project reverse)
            (projectile-switch-to-buffer unobtrusive)
            ;; org-roam
  	  (org-roam-node-find reverse)
  	  (org-roam-node-insert reverse))))
#+end_src


A few extra config options taken directly from the Vertico github page:
#+begin_src emacs-lisp :tangle yes :results none
  ;; Emacs minibuffer configurations.
  ;; (use-package! emacs
    ;; :custom
    ;; ;; Enable context menu. `vertico-multiform-mode' adds a menu in the minibuffer
    ;; ;; to switch display modes.
    ;; (context-menu-mode t)
    ;; ;; Support opening new minibuffers from inside existing minibuffers.
    ;; (enable-recursive-minibuffers t)
    ;; ;; Hide commands in M-x which do not work in the current mode.  Vertico
    ;; ;; commands are hidden in normal buffers. This setting is useful beyond
    ;; ;; Vertico.
    ;; (read-extended-command-predicate #'command-completion-default-include-p)
    ;; ;; Do not allow the cursor in the minibuffer prompt
    ;; (minibuffer-prompt-properties
    ;;     '(read-only t cursor-intangible t face minibuffer-prompt)))
#+end_src

#+begin_src emacs-lisp :tangle yes :results none
  ;; (use-package! orderless
  ;;   :ensure t
  ;;   :custom
  ;;   (completion-styles '(orderless basic))
  ;;   (completion-category-overrides '((file (styles basic partial-completion)))))
#+end_src

Delete whole words in minibuffers like ~find-file~ or ~M-x~.
#+begin_src emacs-lisp :tangle yes :results none
  ;; (define-key minibuffer-local-map (kbd "<backspace>") 'backward-kill-word)
  ;; (define-key minibuffer-local-map (kbd "DEL") 'backward-kill-word)
#+end_src

** Consult
[[https://github.com/minad/consult][consult.el]] is an Emacs package that enhances search and navigation capabilities within Emacs.
It offers a set of interactive commands and utilities that enable users to perform efficient searches
across different types of data, such as buffers, files, and bookmarks.
Consult provides features like incremental search, fuzzy matching, and filtering, making it easier
for users to find and navigate to specific locations or items within their Emacs environment.

Note that there are alternatives, most prominently Ivy and Helm.
However, those packages are older, less actively maintained, and less leightweight.

# A minium config of consult looks like this:
# #+begin_src emacs-lisp :tangle no
# (use-package! consult
#   ;; Enable automatic preview at point in the *Completions* buffer. This is
#   ;; relevant when you use the default completion UI.
#   :hook (completion-list-mode . consult-preview-at-point-mode)

#   :custom
#   ;; set consult project root
#   (setq consult-project-function #'projectile-project-root)

#   :config
#   (setq consult-narrow-key "<")) ;; "C-+"
# #+end_src

** Marginalia

[[https://github.com/minad/marginalia][marginalia.el]] is a package that enhances the minibuffer completion experience by providing rich contextual
annotations for candidates, helping users make more informed selections.

# A minimal config looks like this:
# #+begin_src emacs-lisp :tangle no
# (use-package! marginalia
#   ;; The :init section is always executed.
#   :init

#   ;; Marginalia must be activated in the :init section of use-package! such that
#   ;; the mode gets enabled right away. Note that this forces loading the
#   ;; package.
#   (marginalia-mode))
# #+end_src

** Embark

[[https://github.com/oantolin/embark][embark]] makes it easy to choose a command to run based on what is near point, both during a minibuffer
completion session (in a way familiar to Helm or Counsel users) and in normal buffers.
# #+begin_src emacs-lisp :tangle no
# (use-package! embark
#   :bind
#   (("C-." . embark-act)         ;; pick some comfortable binding
#    ("C-;" . embark-dwim))        ;; good alternative: M-.
#   ;; ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

#   :init

#   ;; Optionally replace the key help with a completing-read interface
#   (setq prefix-help-command #'embark-prefix-help-command)

#   ;; Show the Embark target at point via Eldoc.  You may adjust the Eldoc
#   ;; strategy, if you want to see the documentation from multiple providers.
#   (add-hook 'eldoc-documentation-functions #'embark-eldoc-first-target)
#   ;; (setq eldoc-documentation-strategy #'eldoc-documentation-compose-eagerly)

#   :config

#   ;; Hide the mode line of the Embark live/completions buffers
#   (add-to-list 'display-buffer-alist
#                '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
#                  nil
#                  (window-parameters (mode-line-format . none)))))
# #+end_src

Integrate Embark with Consult with [[https://github.com/oantolin/embark/blob/master/embark-consult.el][embark-consult.el]]:
# #+begin_src emacs-lisp :tangle yes
# (use-package! embark-consult
#   :hook
#   (embark-collect-mode . consult-preview-at-point-mode))
# #+end_src

* Org-mode
** Directories

#+begin_src elisp :tangle yes
  (use-package! org
    :init
    (setq org-directory "~/Org/"))
#+end_src

** UI
[[https://sophiebos.io/posts/prettifying-emacs-org-mode/#theme][Prettifying Emacs Org-mode]]
*** Fonts
We also want to set font-sizes for different levels in org:
#+begin_src emacs-lisp :results none :tangle yes
  (use-package! org
    :config
    (dolist (face '((org-level-1 . 1.3)
  		  (org-level-2 . 1.25)
  		  (org-level-3 . 1.15)
  		  (org-level-4 . 1.1)
  		  (org-level-5 . 1.1)
  		  (org-level-6 . 1.1)
  		  (org-level-7 . 1.1)
  		  (org-level-8 . 1.1)))
      (set-face-attribute (car face) nil
  			:weight 'semi-bold
  			:height (cdr face))))
#+end_src


#+begin_src emacs-lisp :tangle yes :results none
  (use-package! org
    :config
    (require 'org-indent)
    (set-face-attribute 'org-indent nil
  		      :inherit '(org-hide fixed-pitch)))
#+end_src

#+begin_src emacs-lisp :tangle yes :results none
  (use-package! org
    :config
    (set-face-attribute 'org-block nil
  		      ;; :foreground nil
  		      :inherit 'fixed-pitch
  		      :height 0.9)
    (set-face-attribute 'org-code nil
  		      :inherit '(shadow fixed-pitch)
  		      :height 0.9)
    (set-face-attribute 'org-indent nil
  		      :inherit '(org-hide fixed-pitch)
                        :height 0.85)
    (set-face-attribute 'org-verbatim nil
  		      :inherit '(shadow fixed-pitch)
  		      :height 0.85)
    (set-face-attribute 'org-special-keyword nil
  		      :inherit '(font-lock-comment-face fixed-pitch))
    (set-face-attribute 'org-meta-line nil
  		      :inherit '(font-lock-comment-face fixed-pitch))
    (set-face-attribute 'org-checkbox nil
  		      :inherit 'fixed-pitch))
#+end_src

These are the different highlights:
~code~
=verbatim=
:TAG:

*** Modes
~Emacs~ already has some inbuilt modes that can make ~Org-mode~ look alot prettier.
- ~org-indent-mode~ indents the different headers and blocks.
- ~visual-line-mode~ allows lines to wrap around when they get to long.
- ~variable-picth-mode~ make all the text variable pitched.
- ~display-line-number-mode 0~ removes line numbers in ~Org~ files.

#+begin_src emacs-lisp :results none :tangle yes
  (use-package! org
    :hook
    (org-mode . org-indent-mode)
    (org-mode . variable-pitch-mode)
    (org-mode . visual-line-mode)
    (org-mode-hook . pixel-scroll-precision-mode)
    (org-mode . (lambda () (display-line-numbers-mode 0))))
#+end_src

*** Declutter
Remove emphasis markers (for italics, bold, etc.):
- ~org-pretty-entities~ gives LaTeX codes special chars (\alpha)
- ~org-hide-leading-stars~ hide the stars in headings.
-

#+begin_src emacs-lisp :results none :tangle yes
  (use-package! org
    :config
    (setq org-pretty-entities            t
  	org-use-sub-superscripts       "{}"
  	org-hide-leading-stars         t
          org-ellipsis                   " â–¼"
          org-startup-indented           t ;; TODO should not be here
          org-startup-with-inline-images t))
#+end_src

[[https://github.com/awth13/org-appear][org-appear]] makes it easier to edit text that has been emphasised.
#+begin_src emacs-lisp :results none :tangle yes
  (use-package! org-appear
    :commands (org-appear-mode)
    :hook     (org-mode . org-appear-mode)
    :config
    (setq org-hide-emphasis-markers t)  ; Must be activated for org-appear to work
    (setq org-appear-autoemphasis   t   ; Show bold, italics, verbatim, etc.
          org-appear-autolinks      t   ; Show links
  	org-appear-autosubmarkers t)) ; Show sub- and superscripts
#+end_src

TODO and other tags.
#+begin_src emacs-lisp :results none :tangle yes
  (setq org-log-done                       t
        org-auto-align-tags                t
        org-tags-column                    -80
        org-fold-catch-invisible-edits     'show-and-error
        org-special-ctrl-a/e               t
        org-insert-heading-respect-content t)
#+end_src

*** org-modern
Use [[https://github.com/minad/org-modern][org-modern]] to give a very slick modern UI to ~org-mode~.
#+begin_src emacs-lisp :tangle yes :results none
(use-package! org-modern
  :ensure t
  :after (org)
  :hook
  (org-mode . global-org-modern-mode)
  :config
  (setq org-modern-star 'replace)

  ;; (setq org-modern-keyword
  ;;     '(
  ;;       ("begin_src" . "â‰«")
  ;;       ("end_src" . "â‰ª")
  ;;       ("begin_quote" . "â")
  ;;       ("end_quote" . "âž")
  ;;         (t . t)
  ;;       )
  ;;     )

  (setq org-modern-checkbox
  	'((88 . "ï’§")
  	  (45 . "ï“ƒ")
  	  (32 . "î™€")))

  (setq org-modern-priority
  	'( (?A . "ðŸŸ¥")
           (?B . "ðŸŸ¨")
           (?C . "ðŸŸ©")))

  ;; Headings Starts
  (setq org-modern-replace-stars "â—‰â—‹â—ˆâ—‡âœ³")

  ;; Lists
  (setq org-modern-list
  	'(
  	  (?- . "â€“") ;; -
  	  (?* . "â€¢") ;; *
  	  (?+ . "â€£"))) ;; +
  	  
  ;; TODO
  (setq  org-modern-todo t
  	 org-todo-keywords '((sequence "TODO" "DONE")))
  (setq org-modern-todo-faces
  	'(
  	  ("TODO"
  	   :background "gold"
  	   :foreground "black"
  	   :width 'extra-expanded
  	   :weight 'ultra-bold
  	   :height 1.3
  	   :box (:line-width (0.1 . 0.1) :color "gold")))))
#+end_src

Extra ~org-modern~ settings
#+begin_src emacs-lisp :tangle yes :results none
  (with-eval-after-load 'org
    (setq org-auto-align-tags nil
          org-tags-column 0
          org-fold-catch-invisible-edits 'show-and-error
          org-special-ctrl-a/e t
          org-insert-heading-respect-content t)
    (setq org-modern-hide-stars nil))
#+end_src

**** Test Org-modern
***** TODO Blocks
#+begin_src emacs-lisp :tangle yes :results none
#+end_src

#+begin_quote
#+end_quote
***** Checkboxes
- [X]
- [ ]
- [-]

***** [#A] Prio

***** Progress
- [0/12]

***** Lists
- dash
+ plus
 * dot

*** org-modern-indent
When [[https://github.com/jdtsmith/org-modern-indent][org-modern-indent]] is added to ~MELPA~ then I can use it here.
#+begin_src emacs-lisp :tangle yes :results none
  (use-package! org-modern-indent
    :after org-modern
    :config
  (set-face-attribute 'org-modern-indent-bracket-line nil :family "Jetbrains Mono" :height 1.1)
    :hook
    (org-modern-mode . org-modern-indent-mode))
#+end_src

*** Prettify Tags & Keywords

#+begin_src emacs-lisp :results none :tangle yes
  ;; (defun my/prettify-symbols-setup ()

  ;;   ;; Drawers
  ;;   (push '(":PROPERTIES:" . "î­’") prettify-symbols-alist)

  ;;   ;; Tags
  ;;   (push '(":projects:" . "ï€­") prettify-symbols-alist)
  ;;   (push '(":work:"     . "ï€­") prettify-symbols-alist)
  ;;   (push '(":inbox:"    . "ï¯") prettify-symbols-alist)
  ;;   (push '(":task:"     . "ï€œ") prettify-symbols-alist)
  ;;   (push '(":thesis:"   . "ï‘ˆ") prettify-symbols-alist)
  ;;   (push '(":emacs:"    . "î˜²") prettify-symbols-alist)
  ;;   (push '(":learn:"    . "îˆ¯") prettify-symbols-alist)
  ;;   (push '(":code:"     . "ï’‰") prettify-symbols-alist)

  ;;   (prettify-symbols-mode)
  ;;   )

  ;; (add-hook 'org-mode-hook        #'my/prettify-symbols-setup)
  ;; (add-hook 'org-agenda-mode-hook #'my/prettify-symbols-setup)
#+end_src

*** Olivetti
[[https://github.com/rnkn/olivetti][Olivetti]]
#+begin_src emacs-lisp :tangle yes :results none
  (use-package! olivetti
    :after org
    :hook
    (org-mode . olivetti-mode)
    :config
    (setq olivetti-body-width 100))
#+end_src

*** Valign

#+begin_src elisp :tangle yes
(use-package! valign
    :after org)
(add-hook 'org-mode-hook #'valign-mode)
#+end_src

** org-roam
[[https://www.orgroam.com/][org-roam]] is a way to keep track of notes.
*** Basic configuration
#+begin_src emacs-lisp :tangle yes :results results
  (use-package! org-roam
    :after org
    :init
    (setq org-roam-v2-ack t)
    :custom
    (org-roam-directory (expand-file-name "Roam" org-directory))
    (org-roam-completion-everywhere t)
    (setq org-roam-mode-sections
  	(list #'org-roam-backlinks-insert-section
                #'org-roam-reflinks-insert-section
                #'org-roam-unlinked-references-insert-section))
    :config
    (org-roam-db-autosync-enable)
    (org-roam-setup))
#+end_src

*** org-roam-ui
[[https://github.com/org-roam/org-roam-ui][org-roam-ui]] is a web interface to look and interact with the ~org-roam~ database.

#+begin_src emacs-lisp :tangle yes :results none
(use-package! websocket
    :after org-roam)

(use-package! org-roam-ui
    :after (org-roam websocket)
    :config
        (setq org-roam-ui-sync-theme t
              org-roam-ui-follow t
              org-roam-ui-update-on-save t
              org-roam-ui-open-on-start nil))
#+end_src

Add a keycombination.
#+begin_src emacs-lisp :tangle yes :results none
  (map! :leader
        :desc  "Show graph ui"
    "n r g" #'org-roam-ui-open)
#+end_src

*** [[https://www.orgroam.com/manual.html#The-Org_002droam-Buffer][org-roam Buffer]]
The buffer in org roam can be used
- BacklinksView (preview of) nodes that link to this node
- Reference LinksNodes that reference this node (see Refs)
- Unlinked referencesView nodes that contain text that match the nodes title/alias but are not linked

#+begin_src emacs-lisp :tangle yes :results none
(setq org-roam-mode-sections
      (list #'org-roam-backlinks-section
            #'org-roam-reflinks-section
            #'org-roam-unlinked-references-section))
#+end_src

*** [[HTTPo://www.orgroam.com/manual.html#The-Templating-System][org-roam templates]]
** Hyper Links
#+begin_src elisp :tangle yes
(org-add-link-type "local-html" (lambda (path) (browse-url-xdg-open path)))
#+end_src

** LaTeX
*** preview Compiler
This slows down the preview process
# #+begin_src elisp :tangle yes
# ;; set Compiler
# (setq org-latex-compiler "lualatex")

# ;; lualatex preview
# (setq org-latex-pdf-process
#   '("lualatex -shell-escape -interaction nonstopmode %f"
#     "lualatex -shell-escape -interaction nonstopmode %f"))

# (setq luamagick '(luamagick :programs ("lualatex" "convert")
#        :description "pdf > png"
#        :message "you need to install lualatex and imagemagick."
#        :use-xcolor t
#        :image-input-type "pdf"
#        :image-output-type "png"
#        :image-size-adjust (1.0 . 1.0)
#        :latex-compiler ("lualatex -interaction nonstopmode -output-directory %o %f")
#        :image-converter ("convert -density %D -trim -antialias %f -quality 100 %O")))

# (add-to-list 'org-preview-latex-process-alist luamagick)

# (setq org-preview-latex-default-process 'luamagick)
# #+end_src

*** Unicode Font
This only works with LuaLaTeX

# #+begin_src elisp :tangle yes
#
# (add-to-list 'org-latex-packages-alist '("math-style=ISO,bold-style=ISO,mathrm=sym,mathup=sym,mathit=sym,mathsf=sym,mathbf=sym,mathtt=sym," "unicode-math" t) t)
# (add-to-list 'org-latex-packages-alist '"\\setmainfont{XITS}" t)
# (add-to-list 'org-latex-packages-alist '"\\setmathfont{XITS Math}" t)
# (add-to-list 'org-latex-packages-alist '"\\setmonofont{JetBrainsMonoNerdFont}[Scale=0.85, Contextuals = Alternate, Ligatures=TeX, UprightFont =*-Regular, BoldFont = *-Bold, ItalicFont = *-Italic, BoldItalicFont = *-BoldItalic, ]" t)
#
# #+end_src

*** preview packages

#+begin_src elisp :tangle yes
;; (add-to-list 'org-latex-packages-alist'("" "amsmath" t) t)
;; (add-to-list 'org-latex-packages-alist'("" "amssymb" t) t)
(add-to-list 'org-latex-packages-alist'("" "siunitx" t) t)
(add-to-list 'org-latex-packages-alist'"\\sisetup{locale = US}" t)
(add-to-list 'org-latex-packages-alist'"\\sisetup{output-decimal-marker={.}}" t)
(add-to-list 'org-latex-packages-alist'"\\sisetup{group-minimum-digits = 3}" t)
(add-to-list 'org-latex-packages-alist'"\\sisetup{exponent-product=\\ensuremath{\\cdot}}" t)
(add-to-list 'org-latex-packages-alist'"\\sisetup{group-separator = {\\ensuremath{\\,}}}" t)
(add-to-list 'org-latex-packages-alist'"\\sisetup{group-digits = {integer}}" t)
(add-to-list 'org-latex-packages-alist'"\\sisetup{detect-all = true}" t)

(add-to-list 'org-latex-packages-alist'("" "tikz" t) t)
(add-to-list 'org-latex-packages-alist '"\\usetikzlibrary{snakes,calc,patterns,angles,quotes,math,decorations.pathmorphing,decorations.text,decorations.pathreplacing,decorations.markings,automata,arrows.meta,positioning,external}" t)
(add-to-list 'org-latex-packages-alist'("european,siunitx" "circuitikz" t) t)
(add-to-list 'org-latex-packages-alist'("" "tikz-3dplot" t) t)
(add-to-list 'org-latex-packages-alist'("" "pgfplots" t) t)
(add-to-list 'org-latex-packages-alist'("" "derivative" t) t)
(add-to-list 'org-latex-packages-alist'("" "upgreek" t) t)
(add-to-list 'org-latex-packages-alist'("" "datetime2" t) t)
(add-to-list 'org-latex-packages-alist'"\\DTMsettimestyle{iso}" t)
#+end_src

This is my own LaTeX commands
#+begin_src elisp :tangle yes
(add-to-list 'org-latex-packages-alist'("" "mysty9" t) t)
#+end_src

*** org-latex-preview
[[https://abode.karthinks.com/org-latex-preview/]]

#+begin_src elisp :tangle yes :results none
(use-package! org-latex-preview
  :config
  ;; Increase preview width
  (plist-put org-latex-preview-appearance-options
             :page-width 0.8)

  ;; Increase the size of the latex previews in the text
  (plist-put org-latex-preview-appearance-options
             :zoom 1.3)

  ;; Use dvisvgm to generate previews
  ;; You don't need this, it's the default:
  (setq org-latex-preview-process-default 'dvisvgm)

  ;; Block C-n, C-p etc from opening up previews when using auto-mode
  (setq org-latex-preview-auto-ignored-commands
        '(next-line previous-line mwheel-scroll
          scroll-up-command scroll-down-command))

  ;; Enable consistent equation numbering
  (setq org-latex-preview-numbered t)

  ;; Bonus: Turn on live previews.  This shows you a live preview of a LaTeX
  ;; fragment and updates the preview in real-time as you edit it.
  ;; To preview only environments, set it to '(block edit-special) instead
  (setq org-latex-preview-live t)

  ;; More immediate live-previews -- the default delay is 1 second
  (setq org-latex-preview-live-debounce 0.25)

  :hook
  (org-mode-hook . org-latex-preview-mode))
#+end_src

*** Org Code Block LaTeX Export

#+begin_src elisp :tangle no
;; (require 'ox-latex)
;; (add-to-list 'org-latex-packages-alist '"\\lstset{ basicstyle=\\footnotesize\\ttfamily}")
(setq org-latex-src-block-backend "listings")
(add-to-list 'org-latex-packages-alist '("" "xcolor" t) t)
(add-to-list 'org-latex-packages-alist '("" "listings" t) t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base03}{HTML}{002B36}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base03}{HTML}{002B36}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base02}{HTML}{073642}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base01}{HTML}{586e75}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base00}{HTML}{657b83}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base0}{HTML}{839496}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base1}{HTML}{93a1a1}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base2}{HTML}{EEE8D5}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base3}{HTML}{FDF6E3}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@yellow}{HTML}{B58900}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@orange}{HTML}{CB4B16}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@red}{HTML}{DC322F}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@magenta}{HTML}{D33682}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@violet}{HTML}{6C71C4}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@blue}{HTML}{268BD2}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@cyan}{HTML}{2AA198}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@green}{HTML}{859900}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base02}{HTML}{073642}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base01}{HTML}{586e75}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base00}{HTML}{657b83}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base0}{HTML}{839496}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base1}{HTML}{93a1a1}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base2}{HTML}{EEE8D5}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@base3}{HTML}{FDF6E3}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@yellow}{HTML}{B58900}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@orange}{HTML}{CB4B16}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@red}{HTML}{DC322F}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@magenta}{HTML}{D33682}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@violet}{HTML}{6C71C4}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@blue}{HTML}{268BD2}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@cyan}{HTML}{2AA198}" t)
(add-to-list 'org-latex-packages-alist '"\\definecolor{solarized@green}{HTML}{859900}" t)

;; Ligatures in code blocks
(add-to-list 'org-latex-packages-alist '"\\makeatletter \\renewcommand*\\verbatim@nolig@list{} \\makeatother" t)

(setq org-latex-listings-options
      '(("basicstyle" "\\footnotesize\\ttfamily")
        ("captionpos" "b")
        ("columns" "flexible")
        ("breakatwhitespace" "false")
        ("breaklines" "true")
        ("keepspaces" "true")
        ("numbers" "left")
        ("numberstyle" "\\footnotesize")
        ("numbersep" "5pt")
        ("showspaces" "false")
        ("showstringspaces" "false")
        ("showtabs" "false")
        ("tabsize" "4")
        ("frame" "single")
        ("numberstyle" "\\tiny\\color{solarized@base01}")
        ("keywordstyle" "\\color{solarized@green}")
        ("stringstyle" "\\color{solarized@cyan}\\ttfamily")
        ("identifierstyle" "\\color{solarized@blue}")
        ("commentstyle" "\\color{solarized@base01}")
        ("emphstyle" "\\color{solarized@red}")
        ("rulecolor" "\\color{solarized@base2}")
        ("rulesepcolor" "\\color{solarized@base2}")
        ))
#+end_src
                                         "\\makeatletter"
                                         "\\renewcommand*\\verbatim@nolig@list{}"
                                         "\\makeatother"

** Anki
https://rgoswami.me/posts/anki-decks-orgmode/
https://doubleloop.net/2020/08/02/adding-flashcards-to-your-digital-garden-with-org-roam-and-anki/
#+begin_src elisp :tangle yes
(use-package! anki-editor
  :after org
  ;; (map! :leader
  ;;     :desc "Show graph ui"
  ;;     "n r a " #'anki-editor-cloze-region-auto-incr
  ;;     )
  ;;     "n r a" #'anki-editor-cloze-region-dont-incr
  ;;     "n r a" #'anki-editor-reset-cloze-number
  ;;     "n r a" #'anki-editor-push-tree

  :hook (org-capture-after-finalize . anki-editor-reset-cloze-number) ; Reset cloze-number after each capture.
  :config
  (setq anki-editor-create-decks t ;; Allow anki-editor to create a new deck if it doesn't exist
        anki-editor-org-tags-as-anki-tags t)

  (defun anki-editor-cloze-region-auto-incr (&optional arg)
    "Cloze region without hint and increase card number."
    (interactive)
    (anki-editor-cloze-region my-anki-editor-cloze-number "")
    (setq my-anki-editor-cloze-number (1+ my-anki-editor-cloze-number))
    (forward-sexp))
  (defun anki-editor-cloze-region-dont-incr (&optional arg)
    "Cloze region without hint using the previous card number."
    (interactive)
    (anki-editor-cloze-region (1- my-anki-editor-cloze-number) "")
    (forward-sexp))
  (defun anki-editor-reset-cloze-number (&optional arg)
    "Reset cloze number to ARG or 1"
    (interactive)
    (setq my-anki-editor-cloze-number (or arg 1)))
  (defun anki-editor-push-tree ()
    "Push all notes under a tree."
    (interactive)
    (anki-editor-push-notes '(4))
    (anki-editor-reset-cloze-number))
  ;; Initialize
  (anki-editor-reset-cloze-number))
#+end_src

** Org-auto-tangle
#+begin_src elisp :tangle yes
(use-package! org-auto-tangle
  :defer t
  :hook (org-mode . org-auto-tangle-mode)
  :config (setq org-auto-tangle-default t))

#+end_src

** Org-download

:TODO: Look into =org-download-image-attr-list=

#+begin_src elisp :tangle yes
(require 'org-download)

;; Drag-and-drop to `dired`
(add-hook 'dired-mode-hook 'org-download-enable)
(setq org-download-image-html-width '450
      org-download-image-latex-width '7
      org-download-image-org-width '450)
#+end_src

** org-transclusion

[[https://github.com/nobiot/org-transclusion][org-transclusion]]
#+begin_src emacs-lisp :tangle yes :results none
  ;; (use-package! org-transclusion
  ;;   :after org
  ;;   ;; :init
  ;;   ;; (map!
  ;;   ;;  :map global-map "<f12>" #'org-transclusion-add
  ;;   ;;  :leader
  ;;   ;;  :prefix "n"
  ;;   ;;  :desc "Org Transclusion Mode" "t" #'org-transclusion-mode)
  ;;   )
#+end_src
** Images
When Using images in org-mode they can have a lot of attributes. This function folds them together if I encapsulate them in =:IMAGE_INFO:= and =:END:.=

#+begin_src elisp :tangle yes
;; (defun unpack-image-drawers (&rest r)
;;   "Replace drawers named \"IMAGE_INFO\" with their contents."
;;   (let* ((drawer-name "IMAGE_INFO")
;;         (save-string "#+ATTR_SAVE: true\n")
;;         (image-drawers (reverse (org-element-map (org-element-parse-buffer)
;;                                 'drawer
;;                               (lambda (el)
;;                                 (when (string= drawer-name (org-element-property :drawer-name el))
;;                                   el))))))
;;     (cl-loop for drawer in image-drawers do
;;              (setf (buffer-substring (org-element-property :begin drawer)
;;                                      (- (org-element-property :end drawer) 1))
;;                    (concat save-string
;;                            (buffer-substring (org-element-property :contents-begin drawer)
;;                                              (- (org-element-property :contents-end drawer) 1)))))))

;; (defun repack-image-drawers (&rest r)
;;   "Restore image drawers replaced using `unpack-image-drawers'."
;;   (let* ((drawer-name "IMAGE_INFO")
;;         (save-string "#+ATTR_SAVE: true\n")
;;         (image-paragraphs (reverse (org-element-map (org-element-parse-buffer)
;;                                'paragraph
;;                              (lambda (el)
;;                                (when (string= "true" (nth 0 (org-element-property :attr_save el)))
;;                                  el))))))
;;     (cl-loop for paragraph in image-paragraphs do
;;              (setf (buffer-substring (org-element-property :begin paragraph)
;;                                      (- (org-element-property :contents-begin paragraph) 1))
;;                    (concat ":" drawer-name ":\n"
;;                            (buffer-substring (+ (length save-string) (org-element-property :begin paragraph))
;;                                              (- (org-element-property :contents-begin paragraph) 1))
;;                            "\n:END:")))))


;; (defun apply-with-image-drawers-unpacked (f &rest r)
;;   "Replace drawers named \"IMAGE_INFO\" with their contents, run the function,
;; finally restore the drawers as they were. Also collapses all drawers before returning."
;;   (unpack-image-drawers)
;;   (apply f r)
;;   (repack-image-drawers)
;;   (org-hide-drawer-all))

;; (advice-add #'org-display-inline-images :around #'apply-with-image-drawers-unpacked)
;; (add-hook 'org-export-before-processing-hook 'unpack-image-drawers)
#+end_src


#+ATTR_ORG: :width 100 :center yes
[[file:Org-mode/2024-03-20_16-57-44_screenshot.png]]

* Programming Setup
** Languages
*** Nix
#+begin_src elisp :tangle yes
(use-package! nix-mode
  :hook (nix-mode . lsp-deferred)
  :mode "\\.nix\\'")
#+end_src

*** Rust
rust-analyzer
#+begin_src elisp :tangle yes :results none
(use-package! rust-mode
  :config
  (setq lsp-inlay-hint-enable t)
  (setq lsp-rust-analyzer-display-lifetime-elision-hints-enable "skip_trivial")
  (setq lsp-rust-analyzer-display-chaining-hints t)
  (setq lsp-rust-analyzer-display-lifetime-elision-hints-use-parameter-names t)
  (setq lsp-rust-analyzer-display-closure-return-type-hints t)
  (setq lsp-rust-analyzer-display-parameter-hints t)
  (setq lsp-rust-analyzer-display-reborrow-hints t)
  (setq lsp-rust-all-features t)
  )
#+end_src

*** C/C++
Clangd
#+begin_src elisp :tangle yes
(setq lsp-clients-clangd-args '("-j=3"
				"--background-index"
				"--clang-tidy"
				"--completion-style=detailed"
				"--header-insertion=never"
				"--header-insertion-decorators=0"))
(after! lsp-clangd (set-lsp-priority! 'clangd 2))
#+end_src

*** Pyhton
#+begin_src emacs-lisp :tangle yes :results none
(use-package! python
  :hook (python-mode . lsp-deferred)
  :config
  (setq python-indent-offset 4)
  (setq indent-tabs-mode nil)
  )
#+end_src

*** Octave
[[https://www.gnu.org/software/emacs/manual/html_mono/octave-mode.html][octave-mode]] is a build in mode in Emacs.

~lsp-mode~ as a [[https://emacs-lsp.github.io/lsp-mode/page/lsp-matlab/][lsp-matlab]] configuration.
https://emacs-lsp.github.io/lsp-mode/page/adding-new-language/

#+begin_src emacs-lisp :tangle yes :results none
  ;; Explicitly remove objective-c association and add octave
  (setq auto-mode-alist
        (rassq-delete-all 'objc-mode auto-mode-alist))
(add-to-list 'auto-mode-alist '("\\.m\\'" . octave-mode))
#+end_src

#+begin_src emacs-lisp :tangle yes :results none
(use-package! octave
  ;; :ensure nil
  :after lsp
  ;; :init
  :mode "\\.m\\'"
  :hook (octave-mode . lsp-deferred)
  :config
  ;; (add-to-list 'lsp-language-id-configuration '(".*\\.m$" . "octave"))
  (add-to-list 'lsp-language-id-configuration '(octave-mode . "octave"))
  (lsp-register-client (make-lsp-client
                        :new-connection (lsp-stdio-connection "matlab-language-server")
                        :major-modes 'octave-mode
                        ;; :activation-fn (lsp-activate-on "octave")
                        :server-id 'matlab-language-server))
  )
#+end_src

LSP :: There are no language servers supporting current mode `octave-mode' registered with `lsp-mode'.
This issue might be caused by:
1. The language you are trying to use does not have built-in support in `lsp-mode'. You must install the required support manually. Examples of this are `lsp-java' or `lsp-metals'.
2. The language server that you expect to run is not configured to run for major mode `octave-mode'. You may check that by checking the `:major-modes' that are passed to `lsp-register-client'.
3. The language server that you expect to run has an `:activation-fn` passed to `lsp-register-client` that prevents it supporting this buffer.
4. `lsp-mode' doesn't have any integration for the language behind `octave-mode'. Refer to https://emacs-lsp.github.io/lsp-mode/page/languages and https://langserver.org/ .

*** OpenSCAD
[[https://openscad.org/]]

[[https://emacs-lsp.github.io/lsp-mode/page/lsp-openscad/][lsp-openscad]]

#+begin_src elisp :tangle yes
(use-package! scad-mode
  :mode "\\.scad\\'"
  :hook (scad-mode . lsp-deferred)
  :config
  (map! (:localleader
         (:map (scad-mode-map)
               "e" #'scad-export
               "o" #'scad-open
               "p" #'scad-preview))))
#+end_src
*** LaTeX
Mode: For now ([[https://www.gnu.org/s/auctex/][AUCTeX]])
LSP: [[https://github.com/latex-lsp/texlab][texlab]], [[https://emacs-lsp.github.io/lsp-mode/page/lsp-latex/][lsp-mode]]

#+begin_src emacs-lisp :results none :tangle yes
(use-package! latex
  :hook (LaTeX-mode . lsp-deferred)
  :config
 (after! lsp-mode
    ;; (setq lsp-tex-server 'texlab)
    (setq lsp-tex-server 'digestif)
    )
  )
#+end_src
*** VHDL
[[https://emacs-lsp.github.io/lsp-mode/page/lsp-vhdl/][lsp-vhdl]]
[[https://www.gnu.org/software/emacs/manual/html_mono/vhdl-mode.html][vhdl-mode]] is a build in mode in ~Emacs~.

#+begin_src emacs-lisp :tangle yes :results none
(setq +vhdl-lsp-server 'vhdl-ls
         +vhdl-lsp-server-path nil)
#+end_src


#+begin_src emacs-lisp :tangle yes :results none
;; (use-package! vhdl-ext
;;   :hook ((vhdl-mode . vhdl-ext-mode))
;;   :hook ((vhdl-ts-mode . vhdl-ext-mode))
;;   :init
;;   ;; Can also be set through `M-x RET customize-group RET vhdl-ext':
;;   ;; Comment out/remove the ones you do not need
;;   (setq vhdl-ext-feature-list
;;         '(
;;           ;; font-lock
;;           ;; xref
;;           ;; capf
;;           ;; hierarchy
;;           ;; eglot
;;           lsp
;;           ;; lsp-bridge
;;           ;; lspce
;;           flycheck
;;           beautify
;;           ;; navigation
;;           ;; template
;;           ;; compilation
;;           ;; imenu
;;           ;; which-func
;;           hideshow
;;           ;; time-stamp
;;           ;; ports
;;           )
;;         )
;;   :config
;;   (setq vhdl-modify-date-on-saving nil)
;;   (vhdl-ext-mode-setup))

#+end_src

*** Typst
Mode: [[https://codeberg.org/meow_king/typst-ts-mode][typst-ts-mode]]
LSP: [[https://github.com/Myriad-Dreamin/tinymist][tinymist]]

Setup tinymist

#+begin_src emacs-lisp :results none :tangle yes
(after! typst-ts-mode
  (defun typst-pin-main-file ()
  "Pin the current file as the main Typst file."
  (interactive)
  (lsp-workspace-command-execute "tinymist.pinMain" (vector (buffer-file-name)))
  (message "Pinned %s as main file" (buffer-file-name))))

;; (lsp--execute-command (lsp-make-command :command "tinymist.exportPdf" :arguments (vector (buffer-file-name))))
;; (lsp--execute-command (lsp-make-command :command "tinymist.pinMain" :arguments (vector (buffer-file-name))))

(use-package! typst-ts-mode
  :init
  (setq lsp-typst-project-resolution "lockDatabase"
           lsp-typst-server-command   "tinymist")
  
  (setq-default eglot-workspace-configuration
                '(:tinymist (:projectResolution "lockDatabase")))

  )
#+end_src

*** Toml
#+begin_src emacs-lisp :results none :tangle yes
(use-package! toml-ts-mode
  :after (treesit)
  :mode "\\.toml\\'"
  :init
  ;; Ensure tree-sitter grammar is available
  (add-to-list 'treesit-language-source-alist
               '(toml "https://github.com/uben0/tree-sitter-toml"))
  :config
  )
#+end_src
** Tools
*** Treesitter
#+begin_src emacs-lisp :results none :tangle yes
(use-package! treesit
  :config
  (when-let ((grammar-dir (getenv "TREE_SITTER_GRAMMAR_DIR")))
    (add-to-list 'treesit-extra-load-path grammar-dir))
  )
#+end_src

**** ts-query-highlight
https://git.sr.ht/~meow_king/ts-query-highlight

#+begin_src emacs-lisp :results none :tangle yes
(use-package! ts-query-highlight)
#+end_src

*** Format
#+begin_src elisp :tangle yes
(setq +format-on-save-enabled-modes
      '(not emacs-lisp-mode  ; elisp's mechanisms are good enough
	sql-mode         ; sqlformat is currently broken
	;; tex-mode         ; latexindent is broken
	;; latex-mode
        ))
#+end_src

**** LaTeX

#+begin_src elisp :tangle no
;; (setq-hook! 'latex-mode-hook +format-with 'tex-fmt)

(setq +format-on-save-enabled-modes
      '(tex-mode
        latex-mode))

(set-formatter! 'tex-fmt
  '("tex-fmt"
    ("-s -t 2"))

  :modes
  '((latex-mode ".tex")
    (latex-mode ".bib")
    (latex-mode ".sty")
    (latex-mode ".cls")))
#+end_src

*** LSP
#+begin_src elisp :tangle yes
(use-package! lsp-mode
  :init
  (setq lsp-inlay-hint-enable t
        lsp-inlay-hints-mod t
        lsp-log-io t))
#+end_src

**** lsp-booster

Does not work
#+begin_src emacs-lisp :tangle no :results none
(use-package! lsp-mode
      :preface
      (defun lsp-booster--advice-json-parse (old-fn &rest args)
        "Try to parse bytecode instead of json."
        (or
         (when (equal (following-char) ?#)

           (let ((bytecode (read (current-buffer))))
             (when (byte-code-function-p bytecode)
               (funcall bytecode))))
         (apply old-fn args)))
      (defun lsp-booster--advice-final-command (old-fn cmd &optional test?)
        "Prepend emacs-lsp-booster command to lsp CMD."
        (let ((orig-result (funcall old-fn cmd test?)))
          (if (and (not test?)                             ;; for check lsp-server-present?
                   (not (file-remote-p default-directory)) ;; see lsp-resolve-final-command, it would add extra shell wrapper
                   lsp-use-plists
                   (not (functionp 'json-rpc-connection))  ;; native json-rpc
                   (executable-find "emacs-lsp-booster"))
              (progn
                (message "Using emacs-lsp-booster for %s!" orig-result)
                (cons "emacs-lsp-booster" orig-result))
            orig-result)))
      :init
      (setq lsp-use-plists t)
      ;; Initiate https://github.com/blahgeek/emacs-lsp-booster for performance
      (advice-add (if (progn (require 'json)
                             (fboundp 'json-parse-buffer))
                      'json-parse-buffer
                    'json-read)
                  :around
                  #'lsp-booster--advice-json-parse)
      (advice-add 'lsp-resolve-final-command :around #'lsp-booster--advice-final-command))
#+end_src

** Projectile
#+begin_src elisp :tangle yes
(after! projectile
  (add-to-list 'projectile-project-root-files "platformio.ini"))
#+end_src

