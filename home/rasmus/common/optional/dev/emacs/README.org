#+title: My GNU Emacs Config
#+AUTHOR: Rasmus Enevoldsen
#+PROPERTY: header-args:emacs-lisp :tangle yes
#+STARTUP: overview

* Table of Contents :toc:
- [[#general-setup][General Setup]]
  - [[#eary-load-of-org-mode][Eary load of Org-mode]]
  - [[#garbage-collection][Garbage Collection]]
  - [[#initialize-package-sources][Initialize package sources]]
  - [[#mis][mis]]
- [[#ui-and-theming][UI and Theming]]
  - [[#ui-elements][UI Elements]]
  - [[#theme][Theme]]
  - [[#fonts-and-ligatures][Fonts and Ligatures]]
  - [[#line-numbering][Line Numbering]]
  - [[#modeline][Modeline]]
  - [[#dashboard][Dashboard]]
  - [[#miscallenous-ui-toolssettings][Miscallenous UI Tools/Settings]]
- [[#evil][Evil]]
  - [[#evil-package][Evil Package]]
  - [[#evil-collection-package][Evil Collection Package]]
  - [[#additional-evil-tools][Additional Evil Tools]]
- [[#keybindings][Keybindings]]
  - [[#which-key][Which-key]]
  - [[#general-setup-1][General Setup]]
  - [[#zooming-inout][Zooming In/Out]]
  - [[#global][Global]]
  - [[#miscallenous-settings][Miscallenous Settings]]
- [[#git-integration][Git Integration]]
- [[#terminal-emulation-and-shells][Terminal Emulation and Shells]]
  - [[#clipetty][Clipetty]]
- [[#completion][Completion]]
  - [[#vertico][Vertico]]
  - [[#consult][Consult]]
  - [[#marginalia][Marginalia]]
  - [[#embark][Embark]]
- [[#org-mode][Org-mode]]
  - [[#keybinds][Keybinds]]
  - [[#ui][UI]]
  - [[#src-blocks][src blocks]]
  - [[#org-download][org-download]]
  - [[#toc-org][toc-org]]
  - [[#evil-org][evil-org]]
  - [[#org-roam][org-roam]]
  - [[#valign][valign]]
  - [[#org-latex-preview][org-latex-preview]]
  - [[#company-org-block][company-org-block]]
  - [[#org-agenda][org-agenda]]
  - [[#org-transclusion][org-transclusion]]
- [[#pdf][PDF]]
- [[#development-tools][Development Tools]]
  - [[#direnv][Direnv]]
  - [[#lsp-integration][LSP Integration]]
  - [[#company-mode][Company Mode]]
  - [[#debugger][Debugger]]
  - [[#diagnostics-with-flycheck][Diagnostics with flycheck]]
  - [[#formatting-with-format-all][Formatting with format-all]]
- [[#programming-languages-setup][Programming Languages Setup]]
  - [[#c][C]]
  - [[#c-1][C++]]
  - [[#lisp][Lisp]]
  - [[#lua][Lua]]
  - [[#nix][Nix]]
  - [[#python][Python]]
  - [[#rust][Rust]]
  - [[#octave-mode][Octave mode]]
  - [[#yamljsontomletc][YAML/JSON/TOML/etc]]
  - [[#vhdl][VHDL]]
  - [[#latex][LaTeX]]
  - [[#typst][Typst]]
  - [[#markdown][Markdown]]
- [[#projects-with-projectile][Projects with projectile]]
- [[#dired][Dired]]

*
 Intoduction
Most of this config has been stolen from [[https://github.com/thomaslaich/nix-config/tree/main/home/emacs#diagnostics-with-flycheck][thomaslaich]] on GitHub.
I should also try to steal from [[https://github.com/emacs-tw/awesome-emacs][awesome-emacs]].

* General Setup
#+begin_src emacs-lisp :tangle yes :results none
;;; -*- lexical-binding: t; -*-
#+end_src

** Eary load of Org-mode
CRITICAL: Load custom Org FIRST, before anything else
#+begin_src emacs-lisp :tangle yes :results none
;; Prevent built-in Org from loading
(eval-and-compile
  (setq load-path
        (delete (expand-file-name "org" data-directory) load-path))
  (setq load-path
        (delete (expand-file-name "org-loaddefs.el" data-directory) load-path)))

;; Load the custom org version immediately
(require 'org)

#+end_src
** Garbage Collection
Set a higher garbage collection limit (50MB), and log the startup time on the splash screen:
#+begin_src emacs-lisp :tangle yes :results none
  (setq gc-cons-threshold (* 50 1000 1000))

  (defun efs/display-startup-time ()
    (message "Emacs loaded in %s with %d garbage collections."
             (format "%.2f seconds"
                     (float-time
                      (time-subtract after-init-time before-init-time)))
             gcs-done))

  (add-hook 'emacs-startup-hook #'efs/display-startup-time)
#+end_src


Use [[https://github.com/emacscollective/no-littering][no-littering]] to automatically set common paths to the new user-emacs-directory:
#+begin_src emacs-lisp :tangle yes :results none
  (use-package no-littering)
#+end_src

** Initialize package sources
Not all packages are available in [[https://elpa.gnu.org/][elpa]].
Therefor all package sources needs to be declared.

# #+begin_src emacs-lisp :tangle yes :results none
(add-to-list 'load-path (expand-file-name "lisp" user-emacs-directory))

# (require 'package)

# (setq package-archives '(("melpa" . "https://melpa.org/packages/")
#                          ("org" . "https://orgmode.org/elpa/")
#                          ("elpa" . "https://elpa.gnu.org/packages/")))

# (package-initialize)
# (unless package-archive-contents
#  (package-refresh-contents))
# #+end_src


[[https://github.com/jwiegley/use-package][use-package]] is added automatically by the nix emacs overlay.
Here we just make sure we don't have to keep typing ~:ensure t~:
#+begin_src emacs-lisp :tangle yes :results none
  ;; Initialize use-package on non-Linux platforms
  ;; (unless (package-installed-p 'use-package)
  ;;    (package-install 'use-package))
  ;; 
  ;; (require 'use-package)
  (setq use-package-always-ensure t)
  (setq use-package-verbose t)

  ;; use-package debug
  (setq use-package-compute-statistics t)
#+end_src
** mis

Do not make unnecessary sounds:
#+begin_src emacs-lisp :tangle yes :results none
  (setq ring-bell-function #'ignore)
#+end_src

Install [[https://github.com/purcell/exec-path-from-shell][exec-path-from-shell]] to ensure environment variables inside Emacs look the same as in the my shell:
#+begin_src emacs-lisp :tangle yes :results none
  (use-package exec-path-from-shell)
  (when (memq window-system '(mac ns x))
    (exec-path-from-shell-initialize))
#+end_src
* UI and Theming
** UI Elements

Disable all unnecessary UI elements such as tool bar, menu bar, scroll bar, etc.:

#+begin_src emacs-lisp :tangle yes :results none
(scroll-bar-mode -1) ; Disable visible scrollbar
(tool-bar-mode -1)   ; Disable the toolbar
(menu-bar-mode -1)   ; Disable menu bar
(tooltip-mode -1)    ; Disable tooltips
(set-fringe-mode 10) ; Give some breathing room
#+end_src

** Theme

Theming and fonts is managed by [[https://github.com/nix-community/stylix][stylix]].
#+begin_src emacs-lisp :tangle yes :results none
(use-package catppuccin-theme)
#+end_src

#+begin_src emacs-lisp :tangle yes :results none
  (use-package doom-themes
    :ensure t
    :custom
    ;; Global settings (defaults)
    (doom-themes-enable-bold t)   ; if nil, bold is universally disabled
    (doom-themes-enable-italic t) ; if nil, italics is universally disabled
    ;; for treemacs users
    (doom-themes-treemacs-theme "doom-atom") ; use "doom-colors" for less minimal icon theme
    :config
    (load-theme 'catppuccin t)

    ;; Enable flashing mode-line on errors
    (doom-themes-visual-bell-config)
    ;; Enable custom neotree theme (nerd-icons must be installed!)
    (doom-themes-neotree-config)
    ;; or for treemacs users
    (doom-themes-treemacs-config)
    ;; Corrects (and improves) org-mode's native fontification.
    (doom-themes-org-config))
#+end_src

** Fonts and Ligatures
[[https://protesilaos.com/codelog/2020-09-05-emacs-note-mixed-font-heights/]]
Set fonts
 * default pitch
 * fixed pitch  
 * variable pitch
#+begin_src emacs-lisp :tangle yes :results none
  (set-face-attribute 'default nil :family "Jetbrains Mono" :height 170)
  (set-face-attribute 'fixed-pitch nil :family "Jetbrains Mono" :height 1.0)
  (set-face-attribute 'variable-pitch nil :family "FiraGO" :height 1.0)
#+end_src

We simply enable italics for commented text and keywords:
#+begin_src emacs-lisp :tangle yes :results none
(set-face-attribute 'font-lock-comment-face nil :slant 'italic)
(set-face-attribute 'font-lock-keyword-face nil :slant 'italic)
#+end_src

We still have to enable [[https://github.com/mickeynp/ligature.el][ligatures]]:
#+begin_src emacs-lisp :tangle yes :results none
  (use-package ligature
    :config
    ;; Enable the "www" ligature in every possible major mode
    (ligature-set-ligatures 't '("www"))
    ;; Enable traditional ligature support in eww-mode, if the
    ;; `variable-pitch' face supports it
    (ligature-set-ligatures 'eww-mode '("ff" "fi" "ffi"))
    ;; Enable all Jetbrains Mono ligatures in programming modes
    (ligature-set-ligatures 'prog-mode '("--" "---" "==" "===" "!=" "!==" "=!="
  				       "=:=" "=/=" "<=" ">=" "&&" "&&&" "&="
  				       "++" "+++" "***" ";;" "!!" "??" "???"
  				       "?:" "?." "?=" "<:" ":<"
  				       ":>" ">:" "<:<" "<>" "<<<" ">>>"
  				       "<<" ">>" "||" "-|" "_|_" "|-" "||-"
  				       "|=" "||=" "##" "###" "####"
  				       "#{" "#[" "]#" "#(" "#?" "#_" "#_("
  				       "#:" "#!" "#=" "^=" "<$>" "<$"
  				       "$>" "<+>" "<+" "+>" "<*>" "<*" "*>"
  				       "</" "</>" "/>" "<!--" "<#--"
  				       "-->" "->" "->>" "<<-" "<-" "<=<" "=<<"
  				       "<<=" "<==" "<=>" "<==>"
  				       "==>" "=>" "=>>" ">=>" ">>=" ">>-" ">-"
  				       "-<" "-<<" ">->" "<-<" "<-|"
  				       "<=|" "|=>" "|->" "<->" "<~~" "<~"
  				       "<~>" "~~" "~~>" "~>" "~-" "-~"
  				       "~@" "[||]" "|]" "[|" "|}" "{|" "[<"
  				       ">]" "|>" "<|" "||>" "<||"
  				       "|||>" "<|||" "<|>" "..." ".." ".="
  				       "..<" ".?" "::" ":::" ":=" "::="
  				       ":?" ":?>" "//" "///" "/*" "*/" "/="
  				       "//=" "/==" "@_" "__" "???"
  				       "<:<" ";;;"
  				       )
  			  )
    (global-ligature-mode t))
#+end_src


Letâ€™s also adjust the line height (mostly for org-modern to work correctly):
#+begin_src emacs-lisp :tangle yes :results none
  (setq-default line-spacing 0.15)
#+end_src

Last, we enable nerd-icons.el:
#+begin_src emacs-lisp :tangle yes :results none
(use-package nerd-icons)
#+end_src

** Line Numbering

Configure relative line numbers in all buffers:
#+begin_src emacs-lisp :tangle yes :results none
(column-number-mode)
(display-line-numbers-mode t)
(setq display-line-numbers-type 'relative)
(global-display-line-numbers-mode t)
(setq global-display-line-numbers-type 'relative)
#+end_src

Disable line numbers specifically in org-mode, and all shell environments:
#+begin_src emacs-lisp :tangle yes :results none
  (dolist (mode '(
                  org-agenda-mode-hook
                  term-mode-hook
                  vterm-mode-hook
                  shell-mode-hook
                  eshell-mode-hook
  		))
    (add-hook mode (lambda () (display-line-numbers-mode 0))))
#+end_src

** Modeline

We use the [[https://github.com/seagle0128/doom-modeline][doom-modeline]]:
#+begin_src emacs-lisp :tangle yes :results none
(use-package doom-modeline
  :hook (after-init . doom-modeline-mode))
#+end_src

** Dashboard

On the dashboard (splash screen), we want to:

    Show the emacs logo
    Recent files
    Agenda items
    Bookmarks
    Projects
    Registers

We the use dashboard.el package for this:
#+begin_src emacs-lisp :tangle yes :results none
  (use-package dashboard
    :defer 1
    :init
    (setq initial-buffer-choice 'dashboard-open)
    (setq dashboard-set-heading-icons t)
    (setq dashboard-set-file-icons t)
    ;; (setq dashboard-startup-banner "./banner.txt") ;; use standard emacs logo as banner
    (setq dashboard-startup-banner 'logo)
    (setq dashboard-center-content t) ;; set to 't' for centered content
    (setq dashboard-items '((recents . 5)
                            (agenda . 5)
                            (bookmarks . 3)
                            (projects . 3)
                            (registers . 3)))
    :custom
    (dashboard-modify-heading-icons '((recents . "file-text")
                                      (bookmarks . "book")))
    :config
    (dashboard-setup-startup-hook))
#+end_src

We also inhibit the default splash screen:

#+begin_src emacs-lisp :tangle yes :results none
  (setq inhibit-splash-screen t)
  (setq inhibit-startup-message t)
#+end_src

** Miscallenous UI Tools/Settings

Add transparency:
#+begin_src emacs-lisp :tangle yes :results none
(set-frame-parameter nil 'alpha-background 80) ; For current frame
(add-to-list 'default-frame-alist '(alpha-background . 80)) ; For all new frames henceforth
#+end_src
* Evil
[[https://github.com/emacs-evil/evil][evil]] or ~evil-mode~ is a package that provides Vim keybindings and behaviors within Emacs.

** Evil Package

We enable ~evil-mode~ for normal text buffers first:
#+begin_src emacs-lisp :tangle yes :results none
  (setq evil-want-keybinding nil)
  (use-package evil
    :init
    (setq evil-want-keybinding nil)
    (setq evil-want-C-u-scroll t)
    (setq evil-want-integration t)
    (setq evil-vsplit-window-right t)
    (setq evil-split-window-below t)
    :config
    (evil-mode)
    (evil-set-undo-system 'undo-redo))
#+end_src

** Evil Collection Package
[[https://github.com/emacs-evil/evil-collection][evil-collection]] allows us to enable vim keybindings outside of text buffers, that is,
we then can use evil everywhere in emacs. For example, it will allow us to use
evil in org-agenda, calendar, ~help-mode~, etc.

#+begin_src emacs-lisp :tangle yes :results none
  (use-package evil-collection
    :after evil
    :config
    (evil-collection-init))
#+end_src

** Additional Evil Tools
Apart from the ~evil~ and ~evil-collection~, there are a few packages that improve
~evil-mode~ beyond the standard bindings. All these packages usually have an
equivalent counterpart in (Neo)vim.
*** Evil Comments
[[https://github.com/linktohack/evil-commentary][evil-commentary]] is a simple plugin that enables us to toggle comments with
the keybinding ~gcc~:
#+begin_src emacs-lisp :tangle yes :results none
  (use-package evil-commentary
    :after evil
    :config
    (evil-commentary-mode))
#+end_src

The package is the Emacs counterpart to [[https://github.com/tpope/vim-commentary][commentary.vim]].

*** Evil Surround
[[https://github.com/emacs-evil/evil-surround][evil-surround]] is a package the let's us edit surrounding elements with
the keybinding ~s~ (e.g. ~ds(~ deletes surrounding ~( )~ brackets).

#+begin_src emacs-lisp :tangle yes :results none
  (use-package evil-surround
    :config
    (global-evil-surround-mode 1))
#+end_src

The package is the Emacs counterpart to [[https://github.com/tpope/vim-surround][vim-surround]].

* Keybindings
** Which-key
Emacs [[https://github.com/justbur/emacs-which-key][which-key]] is a powerful package designed to enhance the usability of Emacs by providing users with context-sensitive help for keybindings.
It dynamically displays a popup window listing possible keybindings and their associated commands when a user enters a key sequence.
This feature is particularly helpful for users who are new to Emacs or who want to discover the available functionality without having to memorize all the keybindings.
Emacs ~which-key~ significantly improves the discoverability and efficiency of using Emacs.

We enable it like so:

#+begin_src emacs-lisp :tangle yes :results none
  (use-package which-key
    :config
    (setq which-key-side-window-location 'bottom
          which-key-sort-order #'which-key-key-order-alpha
          which-key-sort-uppercase-first nil
          which-key-add-column-padding 1
          which-key-max-display-columns nil
          which-key-min-display-lines 6
          which-key-side-window-slot -10
          which-key-side-window-max-height 0.25
          which-key-idle-delay 0.8
          which-key-max-description-length 25
          which-key-allow-imprecise-window-fit t
          which-key-separator " â†’ ")
    (which-key-mode 1)
    )
#+end_src
** General Setup
[[https://github.com/noctuid/general.el][general.el]] simplifies defining keybindings greatly.
Letâ€™s install it and enable its evil-setup like so:

#+begin_src emacs-lisp :results none :tangle yes
    (use-package general
      :after evil
      :ensure t
      :config
      (general-evil-setup)
      (message "general has been loaded"))
#+end_src

Set up ~SPC~ and ~,~ as the leader and local leader keys, respectively:

#+begin_src emacs-lisp :tangle yes :results none
  (general-create-definer leader-def
    :states '(normal visual insert emacs)
    :keymaps 'override
    :prefix "SPC" ; set leader
    :global-prefix "M-SPC") ; access leader in insert mode (do we need this?)

  (general-create-definer local-leader-def
    :states '(normal visual insert emacs)
    :keymaps 'override
    :prefix "," ; set leader
    :global-prefix "M-,") ; access leader in insert mode (do we need this?)
#+end_src

** Zooming In/Out

Zooming in and out by using either the ~+~, ~-~ keys or the mouse scroll wheel:
#+begin_src emacs-lisp :tangle yes :results none
(general-define-key "C-=" 'text-scale-increase)
(general-define-key "C--" 'text-scale-decrease)
(general-define-key "<C-wheel-up>" 'text-scale-increase)
(general-define-key "<C-wheel-down>" 'text-scale-decrease)
#+end_src

** Global
*** Top-Level Keybindings
This section contains all keybindings that are directly accessible after pressing the leader key.
#+begin_src emacs-lisp :tangle yes :results none
  (leader-def
    "." 'find-file)
#+end_src

*** Window-Management Keybindings (w)

#+begin_src emacs-lisp :tangle yes :results none
  (global-set-key (kbd "C-h") 'evil-window-left)
  (global-set-key (kbd "C-j") 'evil-window-down)
  (global-set-key (kbd "C-k") 'evil-window-up)
  (global-set-key (kbd "C-l") 'evil-window-right)

      (leader-def
      "w" '(:ignore t :wk "[W]indows")

      ;; Window splits
      "w c" '(evil-window-delete :wk "Close Current Window")
      "w n" '(evil-window-new :wk "New Window")
      "w s" '(evil-window-split :wk "Split (Horizontally)")
      "w v" '(evil-window-vsplit :wk "Split Vertically")
      "w o" '(delete-other-windows :wk "Close Other Windows")
      "w =" '(balance-windows :wk "Balance Windows")
      "w |" '(evil-window-set-width :wk "Set Window Width")
      "w _" '(evil-window-set-height :wk "Set Window Height")

      ;; Window motions
      "w h" '(evil-window-left :wk "Move Left")
      "w j" '(evil-window-down :wk "Move Down")
      "w k" '(evil-window-up :wk "Move Up")
      "w l" '(evil-window-right :wk "Move Right")
      "w w" '(evil-window-next :wk "Next Window")

      ;; Move windows
      "w H" '(buf-move-left :wk "Buffer Move Left")
      "w J" '(buf-move-down :wk "Buffer Move Down")
      "w K" '(buf-move-up :wk "Buffer Move Up")
      "w L" '(buf-move-right :wk "Buffer Move Right"))
#+end_src

** Miscallenous Settings

By default Emacs requires you to hit ESC three times to close the minibuffer. This is annoying, so weâ€™re going to change it to just once:
#+begin_src emacs-lisp :tangle yes :results none
(global-set-key [escape] 'keyboard-escape-quit)
#+end_src

* Git Integration
* Terminal Emulation and Shells
** Clipetty
In the TTY Emacs has a seperate clipboard from the system.

#+begin_src emacs-lisp :tangle yes :results none
  (use-package clipetty
    :ensure t
    :hook (after-init . global-clipetty-mode))
#+end_src

* Completion
https://midirus.com/blog/from-ivy-to-vertico#the-vertco-stack

Here we setup all the grepping and completion in Emacs using the powerful Consult/Vertico/Embark/Corfu ecosystem.
Note that these packages supersede the older (but more established) Ivy/Counsel/etc ecosystem.
** Vertico

[[https://github.com/minad/vertico][vertico.el]] is a package that offers a vertical completion interface, simplifying navigation and selection within the minibuffer.

Letâ€™s activate vertico-mode like so:
#+begin_src emacs-lisp :tangle yes :results none
  (use-package vertico
    :ensure t
    :init
    (vertico-mode)
    (vertico-multiform-mode)
    :config
    (setq vertico-multiform-categories
  	'((file reverse) ;; this is for finding files
  	  (command reverse) ;; this is for M-x
  	  (minor-mode reverse)
  	  (imenu buffer)
  	  (t reverse)))
    (setq vertico-multiform-commands
          '(
  	  ;; projectile
  	  (projectile-find-file reverse)
            (projectile-find-dir reverse)
            (projectile-switch-project reverse)
            (projectile-switch-to-buffer unobtrusive)
            ;; org-roam
  	  (org-roam-node-find reverse)
  	  (org-roam-node-insert reverse)
  	  )))
#+end_src

A few extra config options taken directly from the Vertico github page:
#+begin_src emacs-lisp :tangle yes :results none
  ;; Emacs minibuffer configurations.
  (use-package emacs
    :custom
    ;; Enable context menu. `vertico-multiform-mode' adds a menu in the minibuffer
    ;; to switch display modes.
    (context-menu-mode t)
    ;; Support opening new minibuffers from inside existing minibuffers.
    (enable-recursive-minibuffers t)
    ;; Hide commands in M-x which do not work in the current mode.  Vertico
    ;; commands are hidden in normal buffers. This setting is useful beyond
    ;; Vertico.
    (read-extended-command-predicate #'command-completion-default-include-p)
    ;; Do not allow the cursor in the minibuffer prompt
    (minibuffer-prompt-properties
        '(read-only t cursor-intangible t face minibuffer-prompt)))
#+end_src

#+begin_src emacs-lisp :tangle yes :results none
  ;; Optionally use the `orderless' completion style.
  (use-package orderless
    :ensure t
    :custom
    (completion-styles '(orderless basic))
    (completion-category-overrides '((file (styles basic partial-completion)))))
#+end_src

Delete whole words in minibuffers like ~find-file~ or ~M-x~.
#+begin_src emacs-lisp :tangle yes :results none
  ;; (define-key minibuffer-local-map (kbd "<backspace>") 'backward-kill-word)
  ;; (define-key minibuffer-local-map (kbd "DEL") 'backward-kill-word)
#+end_src

** Consult
[[https://github.com/minad/consult][consult.el]] is an Emacs package that enhances search and navigation capabilities within Emacs.
It offers a set of interactive commands and utilities that enable users to perform efficient searches
across different types of data, such as buffers, files, and bookmarks.
Consult provides features like incremental search, fuzzy matching, and filtering, making it easier
for users to find and navigate to specific locations or items within their Emacs environment.

Note that there are alternatives, most prominently Ivy and Helm.
However, those packages are older, less actively maintained, and less leightweight.

# A minium config of consult looks like this:
# #+begin_src emacs-lisp :tangle no
# (use-package consult
#   ;; Enable automatic preview at point in the *Completions* buffer. This is
#   ;; relevant when you use the default completion UI.
#   :hook (completion-list-mode . consult-preview-at-point-mode)

#   :custom
#   ;; set consult project root
#   (setq consult-project-function #'projectile-project-root)

#   :config
#   (setq consult-narrow-key "<") ;; "C-+"
# )
# #+end_src

** Marginalia

[[https://github.com/minad/marginalia][marginalia.el]] is a package that enhances the minibuffer completion experience by providing rich contextual
annotations for candidates, helping users make more informed selections.

# A minimal config looks like this:
# #+begin_src emacs-lisp :tangle no
# (use-package marginalia
#   ;; The :init section is always executed.
#   :init

#   ;; Marginalia must be activated in the :init section of use-package such that
#   ;; the mode gets enabled right away. Note that this forces loading the
#   ;; package.
#   (marginalia-mode))
# #+end_src

** Embark

[[https://github.com/oantolin/embark][embark]] makes it easy to choose a command to run based on what is near point, both during a minibuffer
completion session (in a way familiar to Helm or Counsel users) and in normal buffers.
# #+begin_src emacs-lisp :tangle no
# (use-package embark
#   :bind
#   (("C-." . embark-act)         ;; pick some comfortable binding
#    ("C-;" . embark-dwim))        ;; good alternative: M-.
#   ;; ("C-h B" . embark-bindings)) ;; alternative for `describe-bindings'

#   :init

#   ;; Optionally replace the key help with a completing-read interface
#   (setq prefix-help-command #'embark-prefix-help-command)

#   ;; Show the Embark target at point via Eldoc.  You may adjust the Eldoc
#   ;; strategy, if you want to see the documentation from multiple providers.
#   (add-hook 'eldoc-documentation-functions #'embark-eldoc-first-target)
#   ;; (setq eldoc-documentation-strategy #'eldoc-documentation-compose-eagerly)

#   :config

#   ;; Hide the mode line of the Embark live/completions buffers
#   (add-to-list 'display-buffer-alist
#                '("\\`\\*Embark Collect \\(Live\\|Completions\\)\\*"
#                  nil
#                  (window-parameters (mode-line-format . none)))))
# #+end_src

Integrate Embark with Consult with [[https://github.com/oantolin/embark/blob/master/embark-consult.el][embark-consult.el]]:
# #+begin_src emacs-lisp :tangle yes
# (use-package embark-consult
#   :hook
#   (embark-collect-mode . consult-preview-at-point-mode))
# #+end_src

* Org-mode

https://github.com/AntheaLiles/research-org-mode

#+begin_src emacs-lisp :results none :tangle yes
  (use-package org
    :init
    (setq org-directory "~/Org/")
    )
#+end_src

** Keybinds
Add a keycombination.
#+begin_src emacs-lisp :tangle yes
  (leader-def
    "o" '(:ignore t :wk "[O]rg"))
#+end_src

*** Doom Fun
[[https://github.com/doomemacs/doomemacs/tree/master/modules/lang/org]]

~Doom Emacs~ has some nice keybind behaver that I want in my config.
This make ~tab~ in ~insert mode~  headings become smaller and ~s-tab~ makes headings bigger.
#+begin_src emacs-lisp :tangle yes :results none
  (defun +org-indent-maybe-h ()
    "Indent the current item (header or item), if possible.
  Made for `org-tab-first-hook' in evil-mode."
    (interactive)
    (cond ((not (and (bound-and-true-p evil-local-mode)
                     (evil-insert-state-p)))
           nil)
          ((and (bound-and-true-p org-cdlatex-mode)
                (or (org-inside-LaTeX-fragment-p)
                    (org-inside-latex-macro-p)))
           nil)
          ((org-at-item-p)
           (if (eq this-command 'org-shifttab)
               (org-outdent-item-tree)
             (org-indent-item-tree))
           t)
          ((org-at-heading-p)
           (ignore-errors
             (if (eq this-command 'org-shifttab)
                 (org-promote)
               (org-demote)))
           t)
          ((org-in-src-block-p t)
           (save-window-excursion
             (org-babel-do-in-edit-buffer
              (call-interactively #'indent-for-tab-command)))
           t)
          ((and (save-excursion
                  (skip-chars-backward " \t")
                  (bolp))
                (org-in-subtree-not-table-p))
           (call-interactively #'tab-to-tab-stop)
           t)))
#+end_src

#+begin_src emacs-lisp :tangle yes :results none
(defun +org-cycle-only-current-subtree-h (&optional arg)
  "Toggle the local fold at the point, and no deeper.
`org-cycle's standard behavior is to cycle between three levels: collapsed,
subtree and whole document. This is slow, especially in larger org buffer. Most
of the time I just want to peek into the current subtree -- at most, expand
*only* the current subtree.

All my (performant) foldings needs are met between this and `org-show-subtree'
(on zO for evil users), and `org-cycle' on shift-TAB if I need it."
  (interactive "P")
  (unless (or (eq this-command 'org-shifttab)
              (and (bound-and-true-p org-cdlatex-mode)
                   (or (org-inside-LaTeX-fragment-p)
                       (org-inside-latex-macro-p))))
    (save-excursion
      (org-beginning-of-line)
      (let (invisible-p)
        (when (and (org-at-heading-p)
                   (or org-cycle-open-archived-trees
                       (not (member org-archive-tag (org-get-tags))))
                   (or (not arg)
                       (setq invisible-p
                             (memq (get-char-property (line-end-position)
                                                      'invisible)
                                   '(outline org-fold-outline)))))
          (unless invisible-p
            (setq org-cycle-subtree-status 'subtree))
          (org-cycle-internal-local)
          t)))))
#+end_src


#+begin_src emacs-lisp :tangle yes :results none
  (use-package org
    :config
    (add-hook 'org-tab-first-hook
               ;; #'+org-yas-expand-maybe-h
               #'+org-indent-maybe-h)
    (add-hook 'org-tab-first-hook
  	     #'+org-cycle-only-current-subtree-h)
    )
#+end_src



#+begin_src emacs-lisp :tangle yes :results none
#+end_src

** UI
[[https://sophiebos.io/posts/prettifying-emacs-org-mode/#theme][Prettifying Emacs Org-mode]]
*** Fonts
We also want to set font-sizes for different levels in org:
#+begin_src emacs-lisp :results none :tangle yes
  (use-package org
    :config
    (dolist (face '((org-level-1 . 1.3)
  		  (org-level-2 . 1.25)
  		  (org-level-3 . 1.15)
  		  (org-level-4 . 1.1)
  		  (org-level-5 . 1.1)
  		  (org-level-6 . 1.1)
  		  (org-level-7 . 1.1)
  		  (org-level-8 . 1.1)))
      (set-face-attribute (car face) nil
  			:weight 'semi-bold
  			:height (cdr face)))
    )
#+end_src


#+begin_src emacs-lisp :tangle yes :results none
  (use-package org
    :config 
    (require 'org-indent)
    (set-face-attribute 'org-indent nil
  		      :inherit '(org-hide fixed-pitch))
    )
#+end_src

#+begin_src emacs-lisp :tangle yes :results none
  (use-package org
    :config 
    (set-face-attribute 'org-block nil
  		      ;; :foreground nil
  		      :inherit 'fixed-pitch
  		      :height 0.9)
    (set-face-attribute 'org-code nil
  		      :inherit '(shadow fixed-pitch)
  		      :height 0.9)
    (set-face-attribute 'org-indent nil
  		      :inherit '(org-hide fixed-pitch)
                        :height 0.85)
    (set-face-attribute 'org-verbatim nil
  		      :inherit '(shadow fixed-pitch)
  		      :height 0.85)
    (set-face-attribute 'org-special-keyword nil
  		      :inherit '(font-lock-comment-face fixed-pitch))
    (set-face-attribute 'org-meta-line nil
  		      :inherit '(font-lock-comment-face fixed-pitch))
    (set-face-attribute 'org-checkbox nil
  		      :inherit 'fixed-pitch)
    ) 
#+end_src

These are the different highlights:
~code~ 
=verbatim=
:TAG:

*** Modes
~Emacs~ already has some inbuilt modes that can make ~Org-mode~ look alot prettier.
- ~org-indent-mode~ indents the different headers and blocks.
- ~visual-line-mode~ allows lines to wrap around when they get to long.
- ~variable-picth-mode~ make all the text variable pitched.
- ~display-line-number-mode 0~ removes line numbers in ~Org~ files.
  
#+begin_src emacs-lisp :results none :tangle yes
  (use-package org
    :hook
    (org-mode . org-indent-mode)
    (org-mode . variable-pitch-mode)
    (org-mode . visual-line-mode)
    (org-mode-hook . pixel-scroll-precision-mode)
    (org-mode . (lambda () (display-line-numbers-mode 0)))
    )
#+end_src

*** Declutter
Remove emphasis markers (for italics, bold, etc.):
- ~org-pretty-entities~ gives LaTeX codes special chars (\alpha)
- ~org-hide-leading-stars~ hide the stars in headings.
- 

#+begin_src emacs-lisp :results none :tangle yes
  (use-package org
    :config
    (setq org-pretty-entities            t
  	org-use-sub-superscripts       "{}"
  	org-hide-leading-stars         t
          org-ellipsis                   " â–¼"
          org-startup-indented           t ;; TODO should not be here
          org-startup-with-inline-images t
  	)
    )
#+end_src

[[https://github.com/awth13/org-appear][org-appear]] makes it easier to edit text that has been emphasised.
#+begin_src emacs-lisp :results none :tangle yes
  (use-package org-appear
    :commands (org-appear-mode)
    :hook     (org-mode . org-appear-mode)
    :config
    (setq org-hide-emphasis-markers t)  ; Must be activated for org-appear to work
    (setq org-appear-autoemphasis   t   ; Show bold, italics, verbatim, etc.
          org-appear-autolinks      t   ; Show links
  	org-appear-autosubmarkers t ; Show sub- and superscripts
  	)
    )
#+end_src

TODO and other tags.
#+begin_src emacs-lisp :results none :tangle yes
  (setq org-log-done                       t
        org-auto-align-tags                t
        org-tags-column                    -80
        org-fold-catch-invisible-edits     'show-and-error
        org-special-ctrl-a/e               t
        org-insert-heading-respect-content t
        )
#+end_src

*** org-modern
Use [[https://github.com/minad/org-modern][org-modern]] to give a very slick modern UI to ~org-mode~.
#+begin_src emacs-lisp :tangle yes :results none
  (use-package org-modern
    :ensure t
    :after (org)
    :hook
    (org-mode . global-org-modern-mode)
    :config
    (setq org-modern-star 'replace)

    (setq org-modern-keyword
  	'(
  	  ("begin_src" . "â‰«")
  	  ("end_src" . "â‰ª")
  	  ("begin_quote" . "â")
  	  ("end_quote" . "âž")
            (t . t)
  	  )
  	)
    
    (setq org-modern-checkbox
  	'(
  	  (88 . "ï’§")
  	  (45 . "ï“ƒ")
  	  (32 . "î™€")
  	  )
  	)
    
    (setq org-modern-priority
  	'(
  	  (?A . "ðŸŸ¥")
            (?B . "ðŸŸ¨")
            (?C . "ðŸŸ©")
  	  )
  	)
    
    ;; Headings Starts
    (setq org-modern-replace-stars "â—‰â—‹â—ˆâ—‡âœ³")

    ;; Lists
    (setq org-modern-list 
  	'(
  	  (?- . "â€“") ;; -
  	  (?* . "â€¢") ;; *
  	  (?+ . "â€£") ;; +
  	  )
  	)
    ;; TODO
    (setq  org-modern-todo t
  	   org-todo-keywords '((sequence "TODO" "DONE")))
    (setq org-modern-todo-faces
  	'(
  	  ("TODO"
  	   :background "gold"
  	   :foreground "black"
  	   :width 'extra-expanded
  	   :weight 'ultra-bold
  	   :height 1.3
  	   :box (:line-width (0.1 . 0.1) :color "gold")
  	   )
  	  )
  	)
    
    )
#+end_src

Extra ~org-modern~ settings
#+begin_src emacs-lisp :tangle yes :results none
  (with-eval-after-load 'org
    (setq org-auto-align-tags nil
          org-tags-column 0
          org-fold-catch-invisible-edits 'show-and-error
          org-special-ctrl-a/e t
          org-insert-heading-respect-content t
  	)
    (setq org-modern-hide-stars nil)
    )
#+end_src

**** Test Org-modern
***** TODO Blocks
#+begin_src emacs-lisp :tangle yes :results none
#+end_src

#+begin_quote 
#+end_quote
***** Checkboxes
- [X]  
- [ ]  
- [-] 

***** [#A] Prio

***** Progress
- [0/12] 
  
***** Lists
- dash
+ plus
 * dot
 
*** org-modern-indent
When [[https://github.com/jdtsmith/org-modern-indent][org-modern-indent]] is added to ~MELPA~ then I can use it here.
#+begin_src emacs-lisp :tangle yes :results none
  (use-package org-modern-indent
    :after org-modern
    :config
  (set-face-attribute 'org-modern-indent-bracket-line nil :family "Jetbrains Mono" :height 1.1)
    :hook
    (org-modern-mode . org-modern-indent-mode)
    )
#+end_src

*** Prettify Tags & Keywords

#+begin_src emacs-lisp :results none :tangle yes
  ;; (defun my/prettify-symbols-setup ()

  ;;   ;; Drawers
  ;;   (push '(":PROPERTIES:" . "î­’") prettify-symbols-alist)

  ;;   ;; Tags
  ;;   (push '(":projects:" . "ï€­") prettify-symbols-alist)
  ;;   (push '(":work:"     . "ï€­") prettify-symbols-alist)
  ;;   (push '(":inbox:"    . "ï¯") prettify-symbols-alist)
  ;;   (push '(":task:"     . "ï€œ") prettify-symbols-alist)
  ;;   (push '(":thesis:"   . "ï‘ˆ") prettify-symbols-alist)
  ;;   (push '(":emacs:"    . "î˜²") prettify-symbols-alist)
  ;;   (push '(":learn:"    . "îˆ¯") prettify-symbols-alist)
  ;;   (push '(":code:"     . "ï’‰") prettify-symbols-alist)

  ;;   (prettify-symbols-mode)
  ;;   )

  ;; (add-hook 'org-mode-hook        #'my/prettify-symbols-setup)
  ;; (add-hook 'org-agenda-mode-hook #'my/prettify-symbols-setup)
#+end_src

*** Olivetti 
[[https://github.com/rnkn/olivetti][Olivetti]]
#+begin_src emacs-lisp :tangle yes :results none
  (use-package olivetti
    :after org
    :hook
    (org-mode . olivetti-mode)
    :config
    (setq olivetti-body-width 100)
    )
#+end_src

** src blocks
*** TODO Get format to work in src blocks
#+begin_src emacs-lisp :results none :tangle yes
  (use-package org
    :config
    (setq org-src-fontify-natively t
  	org-src-tab-acts-natively t
  	org-edit-src-content-indentation 2
      )
    )
#+end_src

** org-download
[[https://github.com/abo-abo/org-download][org-download]] helps with downloading images.
#+begin_src emacs-lisp :tangle yes :results none
  (use-package org-download
    :after org)
#+end_src

Set the most common image attributes.
#+begin_src emacs-lisp :tangle yes :results none
  (use-package org-download
    :config
    (setq org-download-image-html-width '450
  	org-download-image-latex-width '7
  	org-download-image-org-width '450)
    )
#+end_src

** toc-org
[[https://github.com/snosov1/toc-org][toc-org]] allows to generate â€œTable of Contentsâ€ sections in org document by simply using the tag :toc:.
You can see an example of this in this very document.

We install and enable it like so:
#+begin_src emacs-lisp :tangle yes :results none
  (use-package toc-org
    :commands toc-org-enable
    :init (add-hook 'org-mode-hook 'toc-org-enable))
#+end_src

** evil-org
[[https://github.com/Somelauw/evil-org-mode][evil-org]] is a way to introduce ~evil~ bindings into ~org-mode~.

#+begin_src emacs-lisp :tangle yes :results none
  (use-package evil-org
    :ensure t
    :after (evil org)
    :hook (org-mode . (lambda () evil-org-mode))
    :config
    (require 'evil-org-agenda)
    (evil-org-agenda-set-keys)
    (evil-org-set-key-theme '(textobjects
  			    insert
  			    navigation
  			    additional
  			    shift
  			    todo
  			    heading)))
#+end_src

** org-roam
[[https://www.orgroam.com/][org-roam]] is a way to keep track of notes.
*** Basic configuration
#+begin_src emacs-lisp :tangle yes :results results
  (use-package org-roam
    :after org
    :init
    (setq org-roam-v2-ack t)
    :custom
    (org-roam-directory (expand-file-name "Roam" org-directory))
    (org-roam-completion-everywhere t)
    (setq org-roam-mode-sections
  	(list #'org-roam-backlinks-insert-section
                #'org-roam-reflinks-insert-section
                #'org-roam-unlinked-references-insert-section))
    :config
    (org-roam-db-autosync-enable)
    (org-roam-setup))
#+end_src

*** Keybinds
Add a keycombination.
#+begin_src emacs-lisp :tangle yes :results none
  (leader-def
    "o r" '(:ignore t :wk "[R]oam")
    "o r f" '(org-roam-node-find :wk "Find Org Roam Node")
    "o r s" '(org-roam-db-sync :wk "Sync Org Roam Database")
    "o r i" '(org-roam-node-insert :wk "Insert Org Roam Link"))
#+end_src

*** org-roam-ui
[[https://github.com/org-roam/org-roam-ui][org-roam-ui]] is a web interface to look and interact with the ~org-roam~ database.

#+begin_src emacs-lisp :tangle yes :results none
(use-package websocket
    :after org-roam)

(use-package org-roam-ui
    :after (org-roam websocket)
    :config
        (setq org-roam-ui-sync-theme t
              org-roam-ui-follow t
              org-roam-ui-update-on-save t
              org-roam-ui-open-on-start nil))
#+end_src

Add a keycombination.
#+begin_src emacs-lisp :tangle yes :results none
  (leader-def
    "o r g" '(org-roam-ui-open :wk "Show graph ui"))
#+end_src

*** [[https://www.orgroam.com/manual.html#The-Org_002droam-Buffer][org-roam Buffer]]
The buffer in org roam can be used
- BacklinksView (preview of) nodes that link to this node
- Reference LinksNodes that reference this node (see Refs)
- Unlinked referencesView nodes that contain text that match the nodes title/alias but are not linked

#+begin_src emacs-lisp :tangle yes :results none
(setq org-roam-mode-sections
      (list #'org-roam-backlinks-section
            #'org-roam-reflinks-section
            #'org-roam-unlinked-references-section
            ))
#+end_src

*** [[HTTPo://www.orgroam.com/manual.html#The-Templating-System][org-roam templates]]
** valign
#+begin_src emacs-lisp :tangle yes :results none
  (use-package valign
    :after org
    :hook
    (org-mode . valign-mode)
    )
#+end_src

| Hello    | this  | is a table | a  |
| it keeps | going | a          | aa |

** org-latex-preview 
[[https://abode.karthinks.com/org-latex-preview/][org-latex-preview]] is a new way of generating LaTaX preview.
#+begin_src emacs-lisp :results none :tangle yes
  (use-package org-latex-preview
    :ensure nil
    :config
    ;; Increase preview width
    (plist-put org-latex-preview-appearance-options
               :page-width 0.8)

    ;; Use dvisvgm to generate previews
    ;; You don't need this, it's the default:
    (setq org-latex-preview-process-default 'dvisvgm)

    ;; Enable consistent equation numbering
    (setq org-latex-preview-numbered t)

    (setq org-latex-preview-cache 'persist)
    ;; Bonus: Turn on live previews.  This shows you a live preview of a LaTeX
    ;; fragment and updates the preview in real-time as you edit it.
    ;; To preview only environments, set it to '(block edit-special) instead
    (setq org-latex-preview-mode-display-live t)

    ;; More immediate live-previews -- the default delay is 1 second
    (setq org-latex-preview-mode-update-delay 0.25)

    :hook
    (org-mode-hook . org-latex-preview-mode)
    )
#+end_src

#+begin_src emacs-lisp :tangle yes :results none
  (use-package org-latex-preview
    :ensure nil
    :config
    (setq org-latex-preview-preamble
  	"\\documentclass{article}
  [DEFAULT-PACKAGES]
  [PACKAGES]
  \\usepackage{xcolor}"
  	)
    
    (add-to-list 'org-latex-packages-alist'("" "amsmath" t) t)
    (add-to-list 'org-latex-packages-alist'("" "amssymb" t) t)
    (add-to-list 'org-latex-packages-alist'("" "siunitx" t) t)
    (add-to-list 'org-latex-packages-alist'("" "tikz" t) t)
    (add-to-list 'org-latex-packages-alist '"\\usetikzlibrary{snakes,calc,patterns,angles,quotes,math,decorations.pathmorphing,decorations.text,decorations.pathreplacing,decorations.markings,automata,arrows.meta,positioning,external}" t)
    (add-to-list 'org-latex-packages-alist'("european,siunitx" "circuitikz" t) t)
    (add-to-list 'org-latex-packages-alist'("" "tikz-3dplot" t) t)
    (add-to-list 'org-latex-packages-alist'("" "pgfplots" t) t)
    (add-to-list 'org-latex-packages-alist'("" "derivative" t) t)
    (add-to-list 'org-latex-packages-alist'("" "upgreek" t) t)
    
    )
#+end_src

**** Test org-latex-preview
\[\alpha = \frac{1}{2}\]
\begin{equation}
\pdv{y}{x} = 4
\end{equation}
\begin{equation}
2 = 4
\end{equation}

** company-org-block
[[https://github.com/xenodium/company-org-block][company-org-block]]
#+begin_src emacs-lisp :tangle yes :results none
  (use-package company-org-block
  :custom
  (company-org-block-edit-style 'auto) ;; 'auto, 'prompt, or 'inline
  :hook
  (org-mode . (lambda ()
                       (setq-local company-backends '(company-org-block))
                       ))
  (org-mode . company-mode)
  )
#+end_src

** org-agenda
#+begin_src emacs-lisp :results none :tangle yes
  (with-eval-after-load 'org
    (setq org-agenda-files (list (expand-file-name "agenda.org" org-directory)))
    (setq org-agenda-window-setup 'current-window)
   )
#+end_src

*** keybinds
#+begin_src emacs-lisp :tangle yes :results none
  (leader-def
    "o a" '(:ignore t :wk "[A]genda")
    "o a A" '(org-agenda :wk "[A]genda Dispatch")
    "o a f" '((lambda () (interactive) (find-file (expand-file-name "agenda.org" org-directory))) :wk "[A]genda Main file")
    )
#+end_src

** org-transclusion

[[https://github.com/nobiot/org-transclusion][org-transclusion]]
#+begin_src emacs-lisp :tangle yes :results none
  ;; (use-package org-transclusion
  ;;   :after org
  ;;   ;; :init
  ;;   ;; (map!
  ;;   ;;  :map global-map "<f12>" #'org-transclusion-add
  ;;   ;;  :leader
  ;;   ;;  :prefix "n"
  ;;   ;;  :desc "Org Transclusion Mode" "t" #'org-transclusion-mode)
  ;;   )
#+end_src
* PDF
Emacs can be a very good PDF viewer with [[https://github.com/vedang/pdf-tools][pdf-tools]].

https://pdftools.wiki/
#+begin_src emacs-lisp :results none :tangle yes
  (use-package pdf-tools
    :mode "\\.pdf\\'"
    :init
    (pdf-tools-install)
    :config
    (setq-default pdf-view-display-size 'fit-page)
    (setq pdf-view-resize-factor 1.1
  	pdf-annot-activate-created-annotations t)
    :hook (pdf-view-mode . (lambda () 
                            (display-line-numbers-mode 0)))
    )
#+end_src

[[https://github.com/007kevin/pdf-view-restore][pdf-view-restore]] is an addon to ~pdf-tools~.
#+begin_src emacs-lisp :results none :tangle yes
  (use-package pdf-view-restore
    :after pdf-tools
    :hook (pdf-view-mode . pdf-view-restore-mode)
    )
#+end_src


#+begin_src emacs-lisp :results none :tangle yes
  (local-leader-def
    :states 'normal
    :keymaps 'pdf-view-mode-map
    "o" 'pdf-outline
    "s" 'pdf-occur
    "+" 'pdf-view-enlarge
    "-" 'pdf-view-shrink
    "0" 'pdf-view-scale-reset
    "r" 'revert-buffer
    "f" 'pdf-view-fit-page-to-window
    "w" 'pdf-view-fit-width-to-window
    "h" 'pdf-view-fit-height-to-window
    )

  ;; Keep navigation keys as direct bindings
  (general-define-key
   :states 'normal
   :keymaps 'pdf-view-mode-map
   "k" 'pdf-view-previous-line-or-previous-page
   "j" 'pdf-view-next-line-or-next-page
   "l" 'image-forward-hscroll
   "h" 'image-backward-hscroll
   "gg" 'pdf-view-first-page
   "G" 'pdf-view-last-page
   ":" 'evil-ex
   "/" 'isearch-forward)

 (defun pdf-isearch-evil-setup ()
  "Setup evil-like n/N behavior for isearch in PDFs."
  (define-key isearch-mode-map (kbd "<return>")
    (lambda () 
      (interactive)
      (isearch-exit)
      ;; Temporarily bind n/N for this search session
      (let ((map (make-sparse-keymap)))
        (define-key map "n" 'isearch-repeat-forward)
        (define-key map "N" 'isearch-repeat-backward)
        (set-transient-map map t))))
  ;; Make sure n/N act as regular characters during search input
  (define-key isearch-mode-map "n" 'isearch-printing-char)
  (define-key isearch-mode-map "N" 'isearch-printing-char))

;; Apply the evil search setup to PDF mode
(add-hook 'pdf-view-mode-hook 
          (lambda ()
            (add-hook 'isearch-mode-hook 'pdf-isearch-evil-setup nil t))) 
#+end_src

* Development Tools
** Direnv
[[https://github.com/wbolster/emacs-direnv][emacs-direnv]] provides [[https://direnv.net/][direnv]] integration for Emacs.
Itâ€™s an essential development tool for me.
#+begin_src emacs-lisp :tangle yes :results none
(use-package direnv
  :config
  (direnv-mode)) ;; direnv integration for emacs
#+end_src
  
** LSP Integration
I use [[https://github.com/emacs-lsp/lsp-mode][lsp-mode]] together with its UI plugins.
Letâ€™s enable ~lsp-mode~ first:

#+begin_src emacs-lisp :tangle yes :results none
  (use-package lsp-mode
    :commands (lsp lsp-deferred)
    :config
    (setq lsp-enable-which-key-integration t
          lsp-prefer-flymake nil
  	lsp-disabled-clients '(ccls)))
#+end_src

[[https://github.com/emacs-lsp/lsp-ui][lsp-ui]] is an addition to ~lsp-mode~ that enables context menus, hover information, etc. to ~lsp-mode~.
It is activated automatically by ~lsp-mode~.

#+begin_src emacs-lisp :tangle yes :results none
  (use-package lsp-ui
    :after lsp-mode
    :config
    (general-evil-define-key 'normal lsp-mode-map
      "K"  'lsp-ui-doc-glance)
    (custom-set-variables '(lsp-ui-doc-position 'at-point))
    )
#+end_src

#+begin_src emacs-lisp :tangle yes :results none
  ;; (use-package lsp-treemacs
  ;;   :commands lsp-treemacs-errors-list)
#+end_src

Keybindings

#+begin_src emacs-lisp :tangle yes :results none
  (use-package lsp-mode
    :after general
    :init
    ;; set prefix for lsp-command-keymap (few alternatives - "C-l", "C-c l")
    (setq lsp-keymap-prefix "C-c l")
    :config
    (general-evil-define-key 'normal lsp-mode-map
      "gd" '(lsp-find-definition :wk "Goto Definition")
      "gD" '(lsp-find-declaration :wk "Goto Declaration")
      "gI" '(lsp-ui-peek-find-implementation :wk "Goto Implementation")
      "gr" '(lsp-ui-peek-find-references :wk "Peek References"))

    (local-leader-def lsp-mode-map
      "r" '(lsp-rename :wk "Rename Symbol")
      "f" '(format-all-buffer :wk "Format Buffer")
      "a" '(lsp-execute-code-action :wk "Code Action")
      )

    (general-define-key
     :keymaps 'lsp-mode-map
     :prefix lsp-keymap-prefix
     "r" '(lsp-rename :wk "Rename Symbol")
     "f" '(format-all-buffer :wk "Format Buffer")
     "a" '(lsp-execute-code-action :wk "Code Action")
     )
    )
#+end_src

** Company Mode
[[https://company-mode.github.io/manual/index.html][company mode]] is a completion framework for ~Emacs~.

#+begin_src emacs-lisp :tangle yes :results none
  (use-package company
    :after lsp-mode
    :hook (lsp-mode . company-mode)
    :bind (:map company-active-map
           ("<tab>" . company-complete-selection))
          (:map lsp-mode-map
           ("<tab>" . company-indent-or-complete-common))
    :custom
    (company-minimum-prefix-length 1)
    (company-idle-delay 0.0))
#+end_src

[[https://github.com/sebastiencs/company-box][company-box]] is a way to add icons to ~company mode~.

#+begin_src emacs-lisp :tangle yes :results none
  (use-package company-box
    :hook (company-mode . company-box-mode))
#+end_src

** Debugger
debugger
https://systemcrafters.net/emacs-ide/debugging-with-dap-mode/

#+begin_src emacs-lisp :tangle yes :results none
  (use-package dap-mode
    :after lsp
    :config
    (general-define-key
    :keymaps 'lsp-mode-map
    :prefix lsp-keymap-prefix
    "d" '(dap-hydra t :wk "debugger")))
#+end_src
** Diagnostics with flycheck

#+begin_src emacs-lisp :tangle yes :results none
(use-package flycheck
  :ensure t
  :init (global-flycheck-mode))
;; (use-package flycheck-pos-tip)
;; (with-eval-after-load 'flycheck
;;   (flycheck-pos-tip-mode))
(setq lsp-eldoc-enable-hover nil)

(use-package flycheck-popup-tip
  :hook (flycheck-mode . flycheck-popup-tip-mode))
#+end_src
** Formatting with format-all

[[https://github.com/lassik/emacs-format-all-the-code][format-all]] or ~emacs-format-all-the-code~ is a package very similar to conform-nvim for neovim.
It supports many formatters for all kinds of different languages.
I prefer dedicated formatters to LSP formatting whenever possible.

#+begin_src emacs-lisp :tangle yes :results output
    (use-package format-all
      :commands format-all-mode
      :hook (prog-mode . format-all-mode)
      :config
      (setq-default format-all-formatters
                    '(
                      ("Nix"     (nixfmt))
                      ("Shell"   (shfmt "-i" "4" "-ci"))
    		  )))
#+end_src

* Programming Languages Setup
** C
Emacs ships with c-mode. We just activate the LSP (clangd) like so:
#+begin_src emacs-lisp :tangle yes :results none
(add-to-list 'major-mode-remap-alist '(c-mode . c-ts-mode))
(add-hook 'c-ts-mode-hook 'lsp-deferred)
#+end_src

Format
#+begin_src emacs-lisp :tangle yes :results none
(eval-after-load 'format-all
  '(add-hook 'c-ts-mode-hook
             (lambda ()
               (setq format-all-formatters
                     '(("C" (clang-format)))))))
#+end_src
** C++
Emacs ships with c-mode. We just activate the LSP (clangd) like so:
#+begin_src emacs-lisp :tangle yes :results none
(add-to-list 'major-mode-remap-alist '(c++-mode . c++-ts-mode))
(add-hook 'c++-ts-mode-hook 'lsp-deferred)
#+end_src

Format
#+begin_src emacs-lisp :tangle yes :results none
(eval-after-load 'format-all
  '(add-hook 'c++-ts-mode-hook
             (lambda ()
               (setq format-all-formatters
                     '(("C++" (clang-format)))))))
#+end_src
** Lisp
** Lua
** Nix
I use [[https://github.com/NixOS/nix-mode][nix-mode]] and active ~lsp-mode~ when entering ~nix-mode~:

#+begin_src emacs-lisp :tangle yes :results none
(use-package nix-mode
  :mode "\\.nix\\'"
  :hook (nix-mode . lsp-deferred))
#+end_src

** Python
** Rust

[[https://github.com/rust-lang/rust-mode][rust-mode]] is very good.
#+begin_src emacs-lisp :tangle yes :results none
  (use-package rust-mode
    :init
    (setq rust-mode-treesitter-derive t)
    )
#+end_src

[[https://emacs-lsp.github.io/lsp-mode/page/lsp-rust-analyzer/][rust-lsp]]
#+begin_src emacs-lisp :tangle yes :results none
  (use-package rust-mode
    :hook (rust-mode . lsp-deferred))
#+end_src

Format
#+begin_src emacs-lisp :tangle yes :results none
  (use-package rust-mode
    :after format-all
    :hook (rust-mode . (lambda ()
                         (setq format-all-formatters
  			     '(("Rust" (rustfmt))))))
    )
#+end_src

** Octave mode
[[https://www.gnu.org/software/emacs/manual/html_mono/octave-mode.html][octave-mode]] is a build in mode in Emacs.
#+begin_src emacs-lisp :tangle yes :results none
  (use-package octave
   :ensure nil
   :mode "\\.m\\'"
   :hook (octave-mode . lsp-deferred))
#+end_src

** YAML/JSON/TOML/etc
** VHDL
[[https://emacs-lsp.github.io/lsp-mode/page/lsp-vhdl/][lsp-vhdl]]
[[https://www.gnu.org/software/emacs/manual/html_mono/vhdl-mode.html][vhdl-mode]] is a build in mode in ~Emacs~.

** LaTeX
[[https://emacs-lsp.github.io/lsp-mode/page/lsp-texlab/][lsp-texlab]]
#+begin_src emacs-lisp :tangle yes :results none
(use-package tex
  :ensure auctex)

  ;; (use-package auctex-latexmk
  ;;   :after tex
  ;;   :custom
  ;;   (auctex-latexmk-inherit-TeX-PDF-mode t)
  ;;   :config
  ;;   (auctex-latexmk-setup))

  ;; (use-package company-auctex
  ;;   ;; :pin melpa
  ;;   :after tex
  ;;   :init
  ;;   (company-auctex-init))
#+end_src
** Typst
[[https://typst.app/docs/][Typst]] is a modern ~LaTeX~ alternetive.

[[https://github.com/Myriad-Dreamin/tinymist][tinymist]] is a ~Typst~ lsp.
It can be [[https://emacs-lsp.github.io/lsp-mode/page/adding-new-language/][added to lsp-mode]].

#+begin_src emacs-lisp :tangle yes :results none
    (use-package typst-ts-mode
     :ensure t
     :mode "\\.typ\\'")
#+end_src
  
#+begin_src emacs-lisp :tangle yes :results none
  (use-package typst-ts-mode
    :hook (typst-ts-mode . lsp-deferred)
    :config
    (add-to-list 'lsp-language-id-configuration '(".*\\.typ$" . "Typst"))
    ;; add typst to lsp-mode
    (lsp-register-client (make-lsp-client
  			:new-connection (lsp-stdio-connection "tinymist")
  			:activation-fn (lsp-activate-on "Typst")
  			:server-id 'tinymist))
    )

  ;; (with-eval-after-load 'lsp-mode
  ;; ;; add typst as a language
#+end_src

~Typst~ can be formatted with [[https://github.com/typstyle-rs/typstyle][typstyle]].
#+begin_src emacs-lisp :tangle yes :results none
  (use-package typst-ts-mode
    :after format-all
    :hook (typst-ts-mode . (lambda ()
  			   (setq format-all-formatters
  				 '(("Typst" (typstyle))))))
    :config
    (define-format-all-formatter typstyle
      (:executable "typstyle")
      (:install
       "cargo install typstyle")
      (:languages "Typst")
      (:features)
      (:format (format-all--buffer-easy executable)))
    )
#+end_src

** Markdown
[[https://jblevins.org/projects/markdown-mode/][markdown-mode]]

#+begin_src emacs-lisp :tangle yes :results none
  (use-package markdown-mode
   :ensure t
   :mode ("README\\.md\\'" . gfm-mode)
   :init (setq markdown-command "multimarkdown")
  )
#+end_src
* Projects with projectile

#+begin_src emacs-lisp :tangle yes :results none
  (use-package projectile
    :after (general vertico)
    :init
    (projectile-mode +1)
    ;; (setq projectile-project-search-path '("~/repos/"))
    ;; (setq projectile-switch-project-action 'projectile-dired)
    (setq projectile-switch-project-action 'projectile-find-file)
    (leader-def "p" '(projectile-command-map :wk "[P]rojects")))
#+end_src

Projectile consult integration:

#+begin_src emacs-lisp :tangle yes :results none
  (use-package consult-projectile)
#+end_src
  
* Dired

#+begin_src emacs-lisp :tangle yes :results none
(use-package peep-dired
  :after dired
  :hook (evil-normalize-keymaps . peep-dired-hook)
  :config
  ;; (general-evil-define-key 'normal dired-mode-map "h" 'dired-up-directory)
  ;; (general-evil-define-key 'normal dired-mode-map "l" 'dired-find-file) ;; replace with dired-find-file once we install dired-open
  (general-evil-define-key 'normal peep-dired-mode-map "h" 'peep-dired-prev-file)
  (general-evil-define-key 'normal peep-dired-mode-map "l" 'peep-dired-next-file)
  )
#+end_src

Auto-refresh dired buffer on file change:

#+begin_src emacs-lisp :tangle yes :results none
(add-hook 'dired-mode-hook 'auto-revert-mode)
#+end_src

